ZiLOG ZNEO Macro Assembler Version 1.10 (07022203)                                               21-Feb-11     01:25:10     page:   1


PC     Object              I  Line    Source 
                           A     1    ; ZiLOG ZNEO ANSI C Compiler Release 1.11
                           A     2    ; -nolocalcse -optsize -model=S -nomodsect -noregvar
                           A     3    ; -reduceopt -debug -peephole -const=ROM -alias -fastcall
                           A     4    	FILE	"..\SPEAKER.C"
                           A     5    .debug "C"
                           A     6    	SEGMENT NEAR_DATA
00000000                   A     7    _note_values:
00000000 00000106          A     8    	DL	262
00000004 00000115          A     9    	DL	277
00000008 00000126          A    10    	DL	294
0000000C 00000137          A    11    	DL	311
00000010 0000014A          A    12    	DL	330
00000014 0000015D          A    13    	DL	349
00000018 00000172          A    14    	DL	370
0000001C 00000188          A    15    	DL	392
00000020 0000019F          A    16    	DL	415
00000024 000001B8          A    17    	DL	440
00000028 000001D2          A    18    	DL	466
0000002C 000001EE          A    19    	DL	494
00000030 0000020B          A    20    	DL	523
00000034 0000022A          A    21    	DL	554
00000038 0000024B          A    22    	DL	587
0000003C 0000026E          A    23    	DL	622
00000040 00000293          A    24    	DL	659
00000044 000002BA          A    25    	DL	698
00000048 000002E4          A    26    	DL	740
0000004C 00000310          A    27    	DL	784
00000050 0000033F          A    28    	DL	831
00000054 00000370          A    29    	DL	880
00000058 000003A4          A    30    	DL	932
0000005C 000003DC          A    31    	DL	988
00000060 00000417          A    32    	DL	1047
00000064 00000455          A    33    	DL	1109
00000068 00000497          A    34    	DL	1175
0000006C 000004DD          A    35    	DL	1245
00000070 00000527          A    36    	DL	1319
00000074 00000575          A    37    	DL	1397
00000078 000005C8          A    38    	DL	1480
0000007C 00000620          A    39    	DL	1568
00000080 0000067D          A    40    	DL	1661
00000084 000006E0          A    41    	DL	1760
00000088 00000749          A    42    	DL	1865
0000008C 000007B8          A    43    	DL	1976
00000090 0000082D          A    44    	DL	2093
00000094 000008A9          A    45    	DL	2217
00000098 0000092D          A    46    	DL	2349
0000009C 000009B9          A    47    	DL	2489
000000A0 00000A4D          A    48    	DL	2637
000000A4 00000AEA          A    49    	DL	2794
000000A8 00000B90          A    50    	DL	2960
000000AC 00000C40          A    51    	DL	3136
000000B0 00000CFA          A    52    	DL	3322
ZiLOG ZNEO Macro Assembler Version 1.10 (07022203)                                               21-Feb-11     01:25:10     page:   2


PC     Object              I  Line    Source speaker.src
000000B4 00000DC0          A    53    	DL	3520
000000B8 00000E91          A    54    	DL	3729
000000BC 00000F6F          A    55    	DL	3951
                           A    56    .define "note_values"
                           A    57    .alias "_note_values"
                           A    58    .class 133
                           A    59    .value _note_values
                           A    60    .dim 4
                           A    61    .dim 12
                           A    62    .type 879
                           A    63    .type 0
                           A    64    .endef
                           A    65    	SEGMENT NEAR_BSS
00000000                   A    66    _duration_timer:
00000000                   A    67    	DS 4*1
                           A    68    .define "duration_timer"
                           A    69    .alias "_duration_timer"
                           A    70    .class 147
                           A    71    .value _duration_timer
                           A    72    .type 6
                           A    73    .type 0
                           A    74    .endef
00000004                   A    75    _duration_cutoff:
00000004                   A    76    	DS 4*1
                           A    77    .define "duration_cutoff"
                           A    78    .alias "_duration_cutoff"
                           A    79    .class 147
                           A    80    .value _duration_cutoff
                           A    81    .type 6
                           A    82    .type 0
                           A    83    .endef
                           A    84    ;    1	#include "speaker.h"
                           A    85    ;    2	#include "timer.h"
                           A    86    ;    3	#include "notes.h"
                           A    87    ;    4	
                           A    88    ;    5	#include <zneo.h>
                           A    89    ;    6	#include <string.h>
                           A    90    ;    7	#include <ctype.h>
                           A    91    ;    8	
                           A    92    ;    9	static void disable_speaker_timer(void);
                           A    93    ;   10	static void init_speaker_timer(void);
                           A    94    ;   11	static void start_speaker_timer(unsigned int frequency);
                           A    95    ;   12	static float beats_to_duration(int beats, int bpm);
                           A    96    ;   13	
                           A    97    ;   14	float duration_timer;
                           A    98    ;   15	float duration_cutoff;
                           A    99    	SEGMENT CODE
                           A   100    ;   16	
                           A   101    ;   17	/*
                           A   102    ;   18		Initialize the speaker IO ports.
                           A   103    ;   19	
                           A   104    ;   20		Ground:PC0
ZiLOG ZNEO Macro Assembler Version 1.10 (07022203)                                               21-Feb-11     01:25:10     page:   3


PC     Object              I  Line    Source speaker.src
                           A   105    ;   21		GPIO:PC1 (timer1 output)
                           A   106    ;   22	 */
                           A   107    ;   23	void init_speaker(void)
                           A   108    ;   24	{
00000000                   A   109    _init_speaker:
                           A   110    .define "_init_speaker"
                           A   111    .value _init_speaker
                           A   112    .class 2
                           A   113    .type 65
                           A   114    .type 0
                           A   115    .endef
                           A   116    .begfunc "init_speaker",24,"_init_speaker"
00000000 0800              A   117    	LINK	#0
                           A   118    ;   25		PCDD &= ~0x03;	//set PC0 and PC1 as outputs
                           A   119    .line 25
00000002 30FC              A   120    	LD	R0,#-4
00000004 7250 E122         A   121    	AND.B	57634:RAM,R0
                           A   122    ;   26		PCOUT &= ~0x03; //set PC0 and PC1 low
                           A   123    .line 26
00000008 7250 E121         A   124    	AND.B	57633:RAM,R0
                           A   125    ;   27	
                           A   126    ;   28		duration_timer = 0;
                           A   127    .line 28
0000000C ADA8 0000         A   128    	CLR	_duration_timer:RAM
                           A   129    ;   29		duration_cutoff = 0;
                           A   130    .line 29
00000010 ADA8 0004         A   131    	CLR	_duration_cutoff:RAM
                           A   132    ;   30	
                           A   133    ;   31		init_speaker_timer();
                           A   134    .line 31
00000014 D115              A   135    	CALL	_init_speaker_timer
                           A   136    ;   32	}
                           A   137    .line 32
00000016 0001              A   138    	UNLINK	
00000018 FFFC              A   139    	RET	
                           A   140    
                           A   141    
                           A   142    ;**************************** _init_speaker ***************************
                           A   143    ;Name                         Addr/Register   Size   Type
                           A   144    ;_init_speaker_timer                 STATIC  -----   function
                           A   145    ;_duration_cutoff                    STATIC      4   variable
                           A   146    ;_duration_timer                     STATIC      4   variable
                           A   147    
                           A   148    
                           A   149    ; Aggregate Stack Size: 0 (words)
                           A   150    
                           A   151    
                           A   152    .endfunc "init_speaker",32,"_init_speaker"
                           A   153    	SEGMENT ROM_TEXT
00000000                   A   154    L__2:
00000000 61                A   155    	DB	"a"
00000001 00                A   156    	DB	0
ZiLOG ZNEO Macro Assembler Version 1.10 (07022203)                                               21-Feb-11     01:25:10     page:   4


PC     Object              I  Line    Source speaker.src
00000002                   A   157    L__4:
00000002 6123              A   158    	DB	"a#"
00000004 00                A   159    	DB	0
00000005                   A   160    L__6:
00000005 62                A   161    	DB	"b"
00000006 00                A   162    	DB	0
00000007                   A   163    L__8:
00000007 63                A   164    	DB	"c"
00000008 00                A   165    	DB	0
00000009                   A   166    L__10:
00000009 6323              A   167    	DB	"c#"
0000000B 00                A   168    	DB	0
0000000C                   A   169    L__12:
0000000C 64                A   170    	DB	"d"
0000000D 00                A   171    	DB	0
0000000E                   A   172    L__14:
0000000E 6423              A   173    	DB	"d#"
00000010 00                A   174    	DB	0
00000011                   A   175    L__16:
00000011 65                A   176    	DB	"e"
00000012 00                A   177    	DB	0
00000013                   A   178    L__18:
00000013 66                A   179    	DB	"f"
00000014 00                A   180    	DB	0
00000015                   A   181    L__20:
00000015 6623              A   182    	DB	"f#"
00000017 00                A   183    	DB	0
00000018                   A   184    L__22:
00000018 67                A   185    	DB	"g"
00000019 00                A   186    	DB	0
0000001A                   A   187    L__24:
0000001A 6723              A   188    	DB	"g#"
0000001C 00                A   189    	DB	0
                           A   190    	SEGMENT CODE
                           A   191    ;   33	
                           A   192    ;   34	/*
                           A   193    ;   35		Play a note in a given octave for a given duration on the speaker.
                           A   194    ;   36	 */
                           A   195    ;   37	void play_note(int octave, unsigned char note[3], int duration, int bpm)
                           A   196    ;   38	{
0000001A                   A   197    _play_note:
                           A   198    .define "_play_note"
                           A   199    .value _play_note
                           A   200    .class 2
                           A   201    .type 65
                           A   202    .type 0
                           A   203    .endef
                           A   204    .begfunc "play_note",38,"_play_note"
0000001A 080E              A   205    	LINK	#14
                           A   206    .line 38
0000001C 5BC1              A   207    	LD	-4(R14),R1
                           A   208    .define "octave"
ZiLOG ZNEO Macro Assembler Version 1.10 (07022203)                                               21-Feb-11     01:25:10     page:   5


PC     Object              I  Line    Source speaker.src
                           A   209    .class 9
                           A   210    .value -4
                           A   211    .type 5
                           A   212    .type 0
                           A   213    .endef
0000001E 57A2              A   214    	LD.W	-6(R14),R2
                           A   215    .define "note"
                           A   216    .class 9
                           A   217    .value -6
                           A   218    .type 140
                           A   219    .type 0
                           A   220    .endef
00000020 5B63              A   221    	LD	-10(R14),R3
                           A   222    .define "duration"
                           A   223    .class 9
                           A   224    .value -10
                           A   225    .type 5
                           A   226    .type 0
                           A   227    .endef
00000022 5B24              A   228    	LD	-14(R14),R4
                           A   229    .define "bpm"
                           A   230    .class 9
                           A   231    .value -14
                           A   232    .type 5
                           A   233    .type 0
                           A   234    .endef
                           A   235    ;   39		//if not lowercase, make lowercase
                           A   236    ;   40		if(!islower(note[0])) {
                           A   237    .line 40
00000024 6FA0              A   238    	LD.SW	R0,-6(R14)
00000026 1801              A   239    	LD.UB	R1,(R0)
00000028 F1 FFFFEA         A   240    	CALL	_islower
0000002C 9000              A   241    	CP	R0,#0
0000002E EE 06             A   242    	JP	NE,_2_L_25
                           A   243    ;   41			note[0] = tolower(note[0]);
                           A   244    .line 41
00000030 6FA0              A   245    	LD.SW	R0,-6(R14)
00000032 1801              A   246    	LD.UB	R1,(R0)
00000034 F1 FFFFE4         A   247    	CALL	_tolower
00000038 6FA1              A   248    	LD.SW	R1,-6(R14)
0000003A 0E01              A   249    	LD.B	(R1),R0
                           A   250    ;   42		}
0000003C                   A   251    _2_L_25:
                           A   252    .line 42
                           A   253    ;   43	
                           A   254    ;   44		//figure out what note it is
                           A   255    ;   45		if(!strncmp(note, "a", 2)) {
                           A   256    .line 45
0000003C 6FA1              A   257    	LD.SW	R1,-6(R14)
0000003E 4502 0000         A   258    	LD	R2,#L__2
00000042 3302              A   259    	LD	R3,#2
00000044 F1 FFFFDC         A   260    	CALL	_strncmp
ZiLOG ZNEO Macro Assembler Version 1.10 (07022203)                                               21-Feb-11     01:25:10     page:   6


PC     Object              I  Line    Source speaker.src
00000048 9000              A   261    	CP	R0,#0
0000004A EE 0B             A   262    	JP	NE,_2_L_24
                           A   263    ;   46			start_speaker_timer(note_values[octave - NUM_OCTAVES][NOTE_A]);
                           A   264    .line 46
0000004C 5FC0              A   265    	LD	R0,-4(R14)
0000004E 80FC              A   266    	ADD	R0,#-4
00000050 3130              A   267    	LD	R1,#48
00000052 B110              A   268    	SMUL	R0,R1
00000054 4511 0000         A   269    	LD	R1,#_note_values
00000058 A010              A   270    	ADD	R0,R1
0000005A 4801 0028         A   271    	LD	R1,40(R0)
0000005E D0FA              A   272    	CALL	_start_speaker_timer
                           A   273    ;   47		}
                           A   274    ;   48		else if(!strncmp(note, "a#", 2))
                           A   275    .line 48
00000060 C0D0              A   276    	JP	_2_L_26
00000062                   A   277    _2_L_24:
00000062 6FA1              A   278    	LD.SW	R1,-6(R14)
00000064 4502 0002         A   279    	LD	R2,#L__4
00000068 3302              A   280    	LD	R3,#2
0000006A F1 FFFFC9         A   281    	CALL	_strncmp
0000006E 9000              A   282    	CP	R0,#0
00000070 EE 0B             A   283    	JP	NE,_2_L_22
                           A   284    ;   49		{
                           A   285    ;   50			start_speaker_timer(note_values[octave - NUM_OCTAVES][NOTE_ASHARP]);
                           A   286    .line 50
00000072 5FC0              A   287    	LD	R0,-4(R14)
00000074 80FC              A   288    	ADD	R0,#-4
00000076 3130              A   289    	LD	R1,#48
00000078 B110              A   290    	SMUL	R0,R1
0000007A 4511 0000         A   291    	LD	R1,#_note_values
0000007E A010              A   292    	ADD	R0,R1
00000080 4801 002C         A   293    	LD	R1,44(R0)
00000084 D0E7              A   294    	CALL	_start_speaker_timer
                           A   295    ;   51		}
                           A   296    ;   52		else if(!strncmp(note, "b", 2))
                           A   297    .line 52
00000086 C0BD              A   298    	JP	_2_L_26
00000088                   A   299    _2_L_22:
00000088 6FA1              A   300    	LD.SW	R1,-6(R14)
0000008A 4502 0005         A   301    	LD	R2,#L__6
0000008E 3302              A   302    	LD	R3,#2
00000090 F1 FFFFB6         A   303    	CALL	_strncmp
00000094 9000              A   304    	CP	R0,#0
00000096 EE 0B             A   305    	JP	NE,_2_L_20
                           A   306    ;   53		{
                           A   307    ;   54			start_speaker_timer(note_values[octave - NUM_OCTAVES][NOTE_B]);
                           A   308    .line 54
00000098 5FC0              A   309    	LD	R0,-4(R14)
0000009A 80FC              A   310    	ADD	R0,#-4
0000009C 3130              A   311    	LD	R1,#48
0000009E B110              A   312    	SMUL	R0,R1
ZiLOG ZNEO Macro Assembler Version 1.10 (07022203)                                               21-Feb-11     01:25:10     page:   7


PC     Object              I  Line    Source speaker.src
000000A0 4511 0000         A   313    	LD	R1,#_note_values
000000A4 A010              A   314    	ADD	R0,R1
000000A6 4801 0030         A   315    	LD	R1,48(R0)
000000AA D0D4              A   316    	CALL	_start_speaker_timer
                           A   317    ;   55		}
                           A   318    ;   56		else if(!strncmp(note, "c", 2))
                           A   319    .line 56
000000AC C0AA              A   320    	JP	_2_L_26
000000AE                   A   321    _2_L_20:
000000AE 6FA1              A   322    	LD.SW	R1,-6(R14)
000000B0 4502 0007         A   323    	LD	R2,#L__8
000000B4 3302              A   324    	LD	R3,#2
000000B6 F1 FFFFA3         A   325    	CALL	_strncmp
000000BA 9000              A   326    	CP	R0,#0
000000BC EE 0B             A   327    	JP	NE,_2_L_18
                           A   328    ;   57		{
                           A   329    ;   58			start_speaker_timer(note_values[octave - NUM_OCTAVES][NOTE_C]);
                           A   330    .line 58
000000BE 5FC0              A   331    	LD	R0,-4(R14)
000000C0 80FC              A   332    	ADD	R0,#-4
000000C2 3130              A   333    	LD	R1,#48
000000C4 B110              A   334    	SMUL	R0,R1
000000C6 4511 0000         A   335    	LD	R1,#_note_values
000000CA A010              A   336    	ADD	R0,R1
000000CC 4801 0004         A   337    	LD	R1,4(R0)
000000D0 D0C1              A   338    	CALL	_start_speaker_timer
                           A   339    ;   59		}
                           A   340    ;   60		else if(!strncmp(note, "c#", 2))
                           A   341    .line 60
000000D2 C097              A   342    	JP	_2_L_26
000000D4                   A   343    _2_L_18:
000000D4 6FA1              A   344    	LD.SW	R1,-6(R14)
000000D6 4502 0009         A   345    	LD	R2,#L__10
000000DA 3302              A   346    	LD	R3,#2
000000DC F1 FFFF90         A   347    	CALL	_strncmp
000000E0 9000              A   348    	CP	R0,#0
000000E2 EE 0B             A   349    	JP	NE,_2_L_16
                           A   350    ;   61		{
                           A   351    ;   62			start_speaker_timer(note_values[octave - NUM_OCTAVES][NOTE_CSHARP]);
                           A   352    .line 62
000000E4 5FC0              A   353    	LD	R0,-4(R14)
000000E6 80FC              A   354    	ADD	R0,#-4
000000E8 3130              A   355    	LD	R1,#48
000000EA B110              A   356    	SMUL	R0,R1
000000EC 4511 0000         A   357    	LD	R1,#_note_values
000000F0 A010              A   358    	ADD	R0,R1
000000F2 4801 0008         A   359    	LD	R1,8(R0)
000000F6 D0AE              A   360    	CALL	_start_speaker_timer
                           A   361    ;   63		}
                           A   362    ;   64		else if(!strncmp(note, "d", 2))
                           A   363    .line 64
000000F8 C084              A   364    	JP	_2_L_26
ZiLOG ZNEO Macro Assembler Version 1.10 (07022203)                                               21-Feb-11     01:25:10     page:   8


PC     Object              I  Line    Source speaker.src
000000FA                   A   365    _2_L_16:
000000FA 6FA1              A   366    	LD.SW	R1,-6(R14)
000000FC 4502 000C         A   367    	LD	R2,#L__12
00000100 3302              A   368    	LD	R3,#2
00000102 F1 FFFF7D         A   369    	CALL	_strncmp
00000106 9000              A   370    	CP	R0,#0
00000108 EE 0B             A   371    	JP	NE,_2_L_14
                           A   372    ;   65		{
                           A   373    ;   66			start_speaker_timer(note_values[octave - NUM_OCTAVES][NOTE_D]);
                           A   374    .line 66
0000010A 5FC0              A   375    	LD	R0,-4(R14)
0000010C 80FC              A   376    	ADD	R0,#-4
0000010E 3130              A   377    	LD	R1,#48
00000110 B110              A   378    	SMUL	R0,R1
00000112 4511 0000         A   379    	LD	R1,#_note_values
00000116 A010              A   380    	ADD	R0,R1
00000118 4801 000C         A   381    	LD	R1,12(R0)
0000011C D09B              A   382    	CALL	_start_speaker_timer
                           A   383    ;   67		}
                           A   384    ;   68		else if(!strncmp(note, "d#", 2))
                           A   385    .line 68
0000011E C071              A   386    	JP	_2_L_26
00000120                   A   387    _2_L_14:
00000120 6FA1              A   388    	LD.SW	R1,-6(R14)
00000122 4502 000E         A   389    	LD	R2,#L__14
00000126 3302              A   390    	LD	R3,#2
00000128 F1 FFFF6A         A   391    	CALL	_strncmp
0000012C 9000              A   392    	CP	R0,#0
0000012E EE 0B             A   393    	JP	NE,_2_L_12
                           A   394    ;   69		{
                           A   395    ;   70			start_speaker_timer(note_values[octave - NUM_OCTAVES][NOTE_DSHARP]);
                           A   396    .line 70
00000130 5FC0              A   397    	LD	R0,-4(R14)
00000132 80FC              A   398    	ADD	R0,#-4
00000134 3130              A   399    	LD	R1,#48
00000136 B110              A   400    	SMUL	R0,R1
00000138 4511 0000         A   401    	LD	R1,#_note_values
0000013C A010              A   402    	ADD	R0,R1
0000013E 4801 0010         A   403    	LD	R1,16(R0)
00000142 D088              A   404    	CALL	_start_speaker_timer
                           A   405    ;   71		}
                           A   406    ;   72		else if(!strncmp(note, "e", 2))
                           A   407    .line 72
00000144 C05E              A   408    	JP	_2_L_26
00000146                   A   409    _2_L_12:
00000146 6FA1              A   410    	LD.SW	R1,-6(R14)
00000148 4502 0011         A   411    	LD	R2,#L__16
0000014C 3302              A   412    	LD	R3,#2
0000014E F1 FFFF57         A   413    	CALL	_strncmp
00000152 9000              A   414    	CP	R0,#0
00000154 EE 0B             A   415    	JP	NE,_2_L_10
                           A   416    ;   73		{
ZiLOG ZNEO Macro Assembler Version 1.10 (07022203)                                               21-Feb-11     01:25:10     page:   9


PC     Object              I  Line    Source speaker.src
                           A   417    ;   74			start_speaker_timer(note_values[octave - NUM_OCTAVES][NOTE_E]);
                           A   418    .line 74
00000156 5FC0              A   419    	LD	R0,-4(R14)
00000158 80FC              A   420    	ADD	R0,#-4
0000015A 3130              A   421    	LD	R1,#48
0000015C B110              A   422    	SMUL	R0,R1
0000015E 4511 0000         A   423    	LD	R1,#_note_values
00000162 A010              A   424    	ADD	R0,R1
00000164 4801 0014         A   425    	LD	R1,20(R0)
00000168 D075              A   426    	CALL	_start_speaker_timer
                           A   427    ;   75		}
                           A   428    ;   76		else if(!strncmp(note, "f", 2))
                           A   429    .line 76
0000016A C04B              A   430    	JP	_2_L_26
0000016C                   A   431    _2_L_10:
0000016C 6FA1              A   432    	LD.SW	R1,-6(R14)
0000016E 4502 0013         A   433    	LD	R2,#L__18
00000172 3302              A   434    	LD	R3,#2
00000174 F1 FFFF44         A   435    	CALL	_strncmp
00000178 9000              A   436    	CP	R0,#0
0000017A EE 0B             A   437    	JP	NE,_2_L_8
                           A   438    ;   77		{
                           A   439    ;   78			start_speaker_timer(note_values[octave - NUM_OCTAVES][NOTE_F]);
                           A   440    .line 78
0000017C 5FC0              A   441    	LD	R0,-4(R14)
0000017E 80FC              A   442    	ADD	R0,#-4
00000180 3130              A   443    	LD	R1,#48
00000182 B110              A   444    	SMUL	R0,R1
00000184 4511 0000         A   445    	LD	R1,#_note_values
00000188 A010              A   446    	ADD	R0,R1
0000018A 4801 0018         A   447    	LD	R1,24(R0)
0000018E D062              A   448    	CALL	_start_speaker_timer
                           A   449    ;   79		}
                           A   450    ;   80		else if(!strncmp(note, "f#", 2))
                           A   451    .line 80
00000190 C038              A   452    	JP	_2_L_26
00000192                   A   453    _2_L_8:
00000192 6FA1              A   454    	LD.SW	R1,-6(R14)
00000194 4502 0015         A   455    	LD	R2,#L__20
00000198 3302              A   456    	LD	R3,#2
0000019A F1 FFFF31         A   457    	CALL	_strncmp
0000019E 9000              A   458    	CP	R0,#0
000001A0 EE 0B             A   459    	JP	NE,_2_L_6
                           A   460    ;   81		{
                           A   461    ;   82			start_speaker_timer(note_values[octave - NUM_OCTAVES][NOTE_FSHARP]);
                           A   462    .line 82
000001A2 5FC0              A   463    	LD	R0,-4(R14)
000001A4 80FC              A   464    	ADD	R0,#-4
000001A6 3130              A   465    	LD	R1,#48
000001A8 B110              A   466    	SMUL	R0,R1
000001AA 4511 0000         A   467    	LD	R1,#_note_values
000001AE A010              A   468    	ADD	R0,R1
ZiLOG ZNEO Macro Assembler Version 1.10 (07022203)                                               21-Feb-11     01:25:10     page:  10


PC     Object              I  Line    Source speaker.src
000001B0 4801 001C         A   469    	LD	R1,28(R0)
000001B4 D04F              A   470    	CALL	_start_speaker_timer
                           A   471    ;   83		}
                           A   472    ;   84		else if(!strncmp(note, "g", 2))
                           A   473    .line 84
000001B6 C025              A   474    	JP	_2_L_26
000001B8                   A   475    _2_L_6:
000001B8 6FA1              A   476    	LD.SW	R1,-6(R14)
000001BA 4502 0018         A   477    	LD	R2,#L__22
000001BE 3302              A   478    	LD	R3,#2
000001C0 F1 FFFF1E         A   479    	CALL	_strncmp
000001C4 9000              A   480    	CP	R0,#0
000001C6 EE 0B             A   481    	JP	NE,_2_L_4
                           A   482    ;   85		{
                           A   483    ;   86			start_speaker_timer(note_values[octave - NUM_OCTAVES][NOTE_G]);
                           A   484    .line 86
000001C8 5FC0              A   485    	LD	R0,-4(R14)
000001CA 80FC              A   486    	ADD	R0,#-4
000001CC 3130              A   487    	LD	R1,#48
000001CE B110              A   488    	SMUL	R0,R1
000001D0 4511 0000         A   489    	LD	R1,#_note_values
000001D4 A010              A   490    	ADD	R0,R1
000001D6 4801 0020         A   491    	LD	R1,32(R0)
000001DA D03C              A   492    	CALL	_start_speaker_timer
                           A   493    ;   87		}
                           A   494    ;   88		else if(!strncmp(note, "g#", 2))
                           A   495    .line 88
000001DC C012              A   496    	JP	_2_L_26
000001DE                   A   497    _2_L_4:
000001DE 6FA1              A   498    	LD.SW	R1,-6(R14)
000001E0 4502 001A         A   499    	LD	R2,#L__24
000001E4 3302              A   500    	LD	R3,#2
000001E6 F1 FFFF0B         A   501    	CALL	_strncmp
000001EA 9000              A   502    	CP	R0,#0
000001EC EE 0A             A   503    	JP	NE,_2_L_26
                           A   504    ;   89		{
                           A   505    ;   90			start_speaker_timer(note_values[octave - NUM_OCTAVES][NOTE_GSHARP]);
                           A   506    .line 90
000001EE 5FC0              A   507    	LD	R0,-4(R14)
000001F0 80FC              A   508    	ADD	R0,#-4
000001F2 3130              A   509    	LD	R1,#48
000001F4 B110              A   510    	SMUL	R0,R1
000001F6 4511 0000         A   511    	LD	R1,#_note_values
000001FA A010              A   512    	ADD	R0,R1
000001FC 4801 0024         A   513    	LD	R1,36(R0)
00000200 D029              A   514    	CALL	_start_speaker_timer
                           A   515    ;   91		}
00000202                   A   516    _2_L_26:
                           A   517    .line 91
                           A   518    ;   92	
                           A   519    ;   93		//set timer for duration of note
                           A   520    ;   94		duration_timer = 0;
ZiLOG ZNEO Macro Assembler Version 1.10 (07022203)                                               21-Feb-11     01:25:10     page:  11


PC     Object              I  Line    Source speaker.src
                           A   521    .line 94
00000202 ADA8 0000         A   522    	CLR	_duration_timer:RAM
                           A   523    ;   95		duration_cutoff = beats_to_duration(duration, bpm);
                           A   524    .line 95
00000206 5F61              A   525    	LD	R1,-10(R14)
00000208 5F22              A   526    	LD	R2,-14(R14)
0000020A D04A              A   527    	CALL	_beats_to_duration
0000020C 0370 0004         A   528    	LD	_duration_cutoff:RAM,R0
                           A   529    ;   96	}
                           A   530    .line 96
00000210 0001              A   531    	UNLINK	
00000212 FFFC              A   532    	RET	
                           A   533    
                           A   534    
                           A   535    ;**************************** _play_note ***************************
                           A   536    ;Name                         Addr/Register   Size   Type
                           A   537    ;_duration_cutoff                    STATIC      4   variable
                           A   538    ;_beats_to_duration                  STATIC  -----   function
                           A   539    ;_duration_timer                     STATIC      4   variable
                           A   540    ;_note_values                        STATIC    192   variable
                           A   541    ;_start_speaker_timer                STATIC  -----   function
                           A   542    ;_strncmp                            IMPORT  -----   function
                           A   543    ;_tolower                            IMPORT  -----   function
                           A   544    ;_islower                            IMPORT  -----   function
                           A   545    ;bpm                                 R14-14      4   parameter
                           A   546    ;duration                            R14-10      4   parameter
                           A   547    ;note                                 R14-6      2   parameter
                           A   548    ;octave                               R14-4      4   parameter
                           A   549    
                           A   550    
                           A   551    ; Aggregate Stack Size: -14 (words)
                           A   552    
                           A   553    
                           A   554    .endfunc "play_note",96,"_play_note"
                           A   555    ;   97	
                           A   556    ;   98	/*
                           A   557    ;   99	 	Stop a note. This function is called by the duration timer.
                           A   558    ;  100	 */
                           A   559    ;  101	void stop_note(void)
                           A   560    ;  102	{
00000214                   A   561    _stop_note:
                           A   562    .define "_stop_note"
                           A   563    .value _stop_note
                           A   564    .class 2
                           A   565    .type 65
                           A   566    .type 0
                           A   567    .endef
                           A   568    .begfunc "stop_note",102,"_stop_note"
00000214 0800              A   569    	LINK	#0
                           A   570    ;  103		disable_speaker_timer();
                           A   571    .line 103
00000216 D00A              A   572    	CALL	_disable_speaker_timer
ZiLOG ZNEO Macro Assembler Version 1.10 (07022203)                                               21-Feb-11     01:25:10     page:  12


PC     Object              I  Line    Source speaker.src
                           A   573    ;  104	}
                           A   574    .line 104
00000218 0001              A   575    	UNLINK	
0000021A FFFC              A   576    	RET	
                           A   577    
                           A   578    
                           A   579    ;**************************** _stop_note ***************************
                           A   580    ;Name                         Addr/Register   Size   Type
                           A   581    ;_disable_speaker_timer              STATIC  -----   function
                           A   582    
                           A   583    
                           A   584    ; Aggregate Stack Size: 0 (words)
                           A   585    
                           A   586    
                           A   587    .endfunc "stop_note",104,"_stop_note"
                           A   588    ;  105	
                           A   589    ;  106	/*
                           A   590    ;  107		Stop playing the ringtone.
                           A   591    ;  108	 */
                           A   592    ;  109	void stop_ringtone(void)
                           A   593    ;  110	{
0000021C                   A   594    _stop_ringtone:
                           A   595    .define "_stop_ringtone"
                           A   596    .value _stop_ringtone
                           A   597    .class 2
                           A   598    .type 65
                           A   599    .type 0
                           A   600    .endef
                           A   601    .begfunc "stop_ringtone",110,"_stop_ringtone"
0000021C 0800              A   602    	LINK	#0
                           A   603    ;  111		duration_cutoff = 0;
                           A   604    .line 111
0000021E ADA8 0004         A   605    	CLR	_duration_cutoff:RAM
                           A   606    ;  112		duration_timer = 0;
                           A   607    .line 112
00000222 ADA8 0000         A   608    	CLR	_duration_timer:RAM
                           A   609    ;  113	
                           A   610    ;  114		disable_speaker_timer();
                           A   611    .line 114
00000226 D002              A   612    	CALL	_disable_speaker_timer
                           A   613    ;  115	}
                           A   614    .line 115
00000228 0001              A   615    	UNLINK	
0000022A FFFC              A   616    	RET	
                           A   617    
                           A   618    
                           A   619    ;**************************** _stop_ringtone ***************************
                           A   620    ;Name                         Addr/Register   Size   Type
                           A   621    ;_disable_speaker_timer              STATIC  -----   function
                           A   622    ;_duration_timer                     STATIC      4   variable
                           A   623    ;_duration_cutoff                    STATIC      4   variable
                           A   624    
ZiLOG ZNEO Macro Assembler Version 1.10 (07022203)                                               21-Feb-11     01:25:10     page:  13


PC     Object              I  Line    Source speaker.src
                           A   625    
                           A   626    ; Aggregate Stack Size: 0 (words)
                           A   627    
                           A   628    
                           A   629    .endfunc "stop_ringtone",115,"_stop_ringtone"
                           A   630    ;  116	
                           A   631    ;  117	/*
                           A   632    ;  118		Disables timer1 and sets PC1 low.
                           A   633    ;  119	 */
                           A   634    ;  120	static void disable_speaker_timer(void)
                           A   635    ;  121	{
0000022C                   A   636    _disable_speaker_timer:
                           A   637    .define "_disable_speaker_timer"
                           A   638    .value _disable_speaker_timer
                           A   639    .class 3
                           A   640    .type 65
                           A   641    .type 0
                           A   642    .endef
                           A   643    .begfunc "disable_speaker_timer",121,"_disable_speaker_timer"
0000022C 0800              A   644    	LINK	#0
                           A   645    ;  122		T1CTL1 |= TIMER_DISABLE;
                           A   646    .line 122
0000022E 0310 E317         A   647    	LD.SB	R0,58135:RAM
                           A   648    ;  123		PCOUT &= ~0x02;	//set PC1 low
                           A   649    .line 123
00000232 30FD              A   650    	LD	R0,#-3
00000234 7250 E121         A   651    	AND.B	57633:RAM,R0
                           A   652    ;  124		PCAF &= ~0x02;
                           A   653    .line 124
00000238 7260 E124         A   654    	AND.W	57636:RAM,R0
                           A   655    ;  125	}
                           A   656    .line 125
0000023C 0001              A   657    	UNLINK	
0000023E FFFC              A   658    	RET	
                           A   659    
                           A   660    
                           A   661    ;**************************** _disable_speaker_timer ***************************
                           A   662    ;Name                         Addr/Register   Size   Type
                           A   663    
                           A   664    
                           A   665    ; Aggregate Stack Size: 0 (words)
                           A   666    
                           A   667    
                           A   668    .endfunc "disable_speaker_timer",125,"_disable_speaker_timer"
                           A   669    ;  126	
                           A   670    ;  127	/*
                           A   671    ;  128		Setup timer1.
                           A   672    ;  129	 */
                           A   673    ;  130	static void init_speaker_timer(void)
                           A   674    ;  131	{
00000240                   A   675    _init_speaker_timer:
                           A   676    .define "_init_speaker_timer"
ZiLOG ZNEO Macro Assembler Version 1.10 (07022203)                                               21-Feb-11     01:25:10     page:  14


PC     Object              I  Line    Source speaker.src
                           A   677    .value _init_speaker_timer
                           A   678    .class 3
                           A   679    .type 65
                           A   680    .type 0
                           A   681    .endef
                           A   682    .begfunc "init_speaker_timer",131,"_init_speaker_timer"
00000240 0800              A   683    	LINK	#0
                           A   684    ;  132		T1CTL1 |= TIMER_DISABLE;
                           A   685    .line 132
00000242 0310 E317         A   686    	LD.SB	R0,58135:RAM
                           A   687    ;  133	
                           A   688    ;  134	    T1CTL1 = TIMER_MODE_CONTINUOUS + TIMER_PRESCALE_64;
                           A   689    .line 134
00000246 3031              A   690    	LD	R0,#49
00000248 0350 E317         A   691    	LD.B	58135:RAM,R0
                           A   692    ;  135	
                           A   693    ;  136	    // Initial counter value
                           A   694    ;  137	    T1HL = 0x00;
                           A   695    .line 137
0000024C ADA4 E310         A   696    	CLR.W	58128:RAM
                           A   697    ;  138	}
                           A   698    .line 138
00000250 0001              A   699    	UNLINK	
00000252 FFFC              A   700    	RET	
                           A   701    
                           A   702    
                           A   703    ;**************************** _init_speaker_timer ***************************
                           A   704    ;Name                         Addr/Register   Size   Type
                           A   705    
                           A   706    
                           A   707    ; Aggregate Stack Size: 0 (words)
                           A   708    
                           A   709    
                           A   710    .endfunc "init_speaker_timer",138,"_init_speaker_timer"
                           A   711    ;  139	
                           A   712    ;  140	/*
                           A   713    ;  141	 	Enable timer 1. The timer will go off every
                           A   714    ;  142		1 / (2 * frequency) seconds.
                           A   715    ;  143	 */
                           A   716    ;  144	static void start_speaker_timer(unsigned int frequency)
                           A   717    ;  145	{
00000254                   A   718    _start_speaker_timer:
                           A   719    .define "_start_speaker_timer"
                           A   720    .value _start_speaker_timer
                           A   721    .class 3
                           A   722    .type 65
                           A   723    .type 0
                           A   724    .endef
                           A   725    .begfunc "start_speaker_timer",145,"_start_speaker_timer"
                           A   726    .line 145
                           A   727    .define "frequency"
                           A   728    .class 17
ZiLOG ZNEO Macro Assembler Version 1.10 (07022203)                                               21-Feb-11     01:25:10     page:  15


PC     Object              I  Line    Source speaker.src
                           A   729    .reg 2
                           A   730    .type 15
                           A   731    .type 0
                           A   732    .endef
                           A   733    .define "timeout"
                           A   734    .class 1
                           A   735    .value -4
                           A   736    .type 6
                           A   737    .type 0
                           A   738    .endef
00000254 0804              A   739    	LINK	#4
00000256 05C0              A   740    	PUSHMHI	#3
                           A   741    ;  146		float timeout;
                           A   742    ;  147	
                           A   743    ;  148		//calculate the timeout
                           A   744    ;  149		//timeout = 1.0f / (2.0f * (float)frequency);
                           A   745    ;  150		timeout = 1.0f / (float)frequency;
                           A   746    .line 150
00000258 4418              A   747    	LD	R8,R1
0000025A F1 FFFED1         A   748    	CALL	__fpultof
0000025E 4409              A   749    	LD	R9,R0
00000260 4528 3F800000     A   750    	LD	R8,#1065353216
00000266 F1 FFFECB         A   751    	CALL	__fpdiv
0000026A 5BC0              A   752    	LD	-4(R14),R0
                           A   753    ;  151	
                           A   754    ;  152		// Initial counter value
                           A   755    ;  153	    T1HL = 0x00;
                           A   756    .line 153
0000026C ADA4 E310         A   757    	CLR.W	58128:RAM
                           A   758    ;  154	
                           A   759    ;  155		// Timer reload
                           A   760    ;  156	    //   reload = clock / prescale * timeout  
                           A   761    ;  157	    T1R = CLOCK / 64 * timeout;
                           A   762    .line 157
00000270 5FC8              A   763    	LD	R8,-4(R14)
00000272 4529 47A7D880     A   764    	LD	R9,#1202182272
00000278 F1 FFFEC2         A   765    	CALL	__fpmul
0000027C 4408              A   766    	LD	R8,R0
0000027E F1 FFFEBF         A   767    	CALL	__fpftol
00000282 0360 E312         A   768    	LD.W	58130:RAM,R0
                           A   769    ;  158	
                           A   770    ;  159		// Enable Timer0 interrupt
                           A   771    ;  160	    IRQ1EN = IRQ_Timer1;
                           A   772    .line 160
00000286 3040              A   773    	LD	R0,#64
00000288 0360 E036         A   774    	LD.W	57398:RAM,R0
                           A   775    ;  161	
                           A   776    ;  162		T1CTL1 |= TIMER_ENABLE;
                           A   777    .line 162
0000028C 4500 0080         A   778    	LD	R0,#128
00000290 7350 E317         A   779    	OR.B	58135:RAM,R0
                           A   780    ;  163	
ZiLOG ZNEO Macro Assembler Version 1.10 (07022203)                                               21-Feb-11     01:25:10     page:  16


PC     Object              I  Line    Source speaker.src
                           A   781    ;  164		//set PC1 as T1OUT
                           A   782    ;  165		PCAF |= 0x02;
                           A   783    .line 165
00000294 3002              A   784    	LD	R0,#2
00000296 7360 E124         A   785    	OR.W	57636:RAM,R0
                           A   786    ;  166	}
                           A   787    .line 166
0000029A 0703              A   788    	POPMHI	#3
0000029C 0001              A   789    	UNLINK	
0000029E FFFC              A   790    	RET	
                           A   791    
                           A   792    
                           A   793    ;**************************** _start_speaker_timer ***************************
                           A   794    ;Name                         Addr/Register   Size   Type
                           A   795    ;timeout                              R14-4      4   variable
                           A   796    ;frequency                               R1      4   parameter
                           A   797    
                           A   798    
                           A   799    ; Aggregate Stack Size: -4 (words)
                           A   800    
                           A   801    
                           A   802    .endfunc "start_speaker_timer",166,"_start_speaker_timer"
                           A   803    ;  167	
                           A   804    ;  168	/*
                           A   805    ;  169		Convert a duration to a time value using beats per minute.
                           A   806    ;  170	 */
                           A   807    ;  171	static float beats_to_duration(int beats, int bpm)
                           A   808    ;  172	{
000002A0                   A   809    _beats_to_duration:
                           A   810    .define "_beats_to_duration"
                           A   811    .value _beats_to_duration
                           A   812    .class 3
                           A   813    .type 70
                           A   814    .type 0
                           A   815    .endef
                           A   816    .begfunc "beats_to_duration",172,"_beats_to_duration"
                           A   817    .line 172
                           A   818    .define "beats"
                           A   819    .class 17
                           A   820    .reg 2
                           A   821    .type 5
                           A   822    .type 0
                           A   823    .endef
                           A   824    .define "bpm"
                           A   825    .class 17
                           A   826    .reg 3
                           A   827    .type 5
                           A   828    .type 0
                           A   829    .endef
000002A0 0800              A   830    	LINK	#0
000002A2 05C0              A   831    	PUSHMHI	#3
                           A   832    ;  173		return (60.0f / (float)bpm) * (4.0f / (float)beats);
ZiLOG ZNEO Macro Assembler Version 1.10 (07022203)                                               21-Feb-11     01:25:10     page:  17


PC     Object              I  Line    Source speaker.src
                           A   833    .line 173
000002A4 4428              A   834    	LD	R8,R2
000002A6 F1 FFFEAB         A   835    	CALL	__fpltof
000002AA 4409              A   836    	LD	R9,R0
000002AC 4528 42700000     A   837    	LD	R8,#1114636288
000002B2 F1 FFFEA5         A   838    	CALL	__fpdiv
000002B6 4402              A   839    	LD	R2,R0
000002B8 4418              A   840    	LD	R8,R1
000002BA F1 FFFEA1         A   841    	CALL	__fpltof
000002BE 4409              A   842    	LD	R9,R0
000002C0 4528 40800000     A   843    	LD	R8,#1082130432
000002C6 F1 FFFE9B         A   844    	CALL	__fpdiv
000002CA 4428              A   845    	LD	R8,R2
000002CC 4409              A   846    	LD	R9,R0
000002CE F1 FFFE97         A   847    	CALL	__fpmul
                           A   848    ;  174		//return ((60.0f / (float)bpm) * (4.0f / (float)beats)) * 4;
                           A   849    ;  175	}
                           A   850    .line 175
000002D2 0703              A   851    	POPMHI	#3
000002D4 0001              A   852    	UNLINK	
000002D6 FFFC              A   853    	RET	
                           A   854    
                           A   855    
                           A   856    ;**************************** _beats_to_duration ***************************
                           A   857    ;Name                         Addr/Register   Size   Type
                           A   858    ;bpm                                     R2      4   parameter
                           A   859    ;beats                                   R1      4   parameter
                           A   860    
                           A   861    
                           A   862    ; Aggregate Stack Size: 0 (words)
                           A   863    
                           A   864    
                           A   865    .endfunc "beats_to_duration",175,"_beats_to_duration"
                           A   866    	XREF _tolower:EROM
                           A   867    	XREF _islower:EROM
                           A   868    	XREF _strncmp:EROM
                           A   869    	XREF __fpltof:EROM
                           A   870    	XREF __fpultof:EROM
                           A   871    	XREF __fpftol:EROM
                           A   872    	XREF __fpdiv:EROM
                           A   873    	XREF __fpmul:EROM
                           A   874    	XDEF _stop_ringtone
                           A   875    	XDEF _stop_note
                           A   876    	XDEF _play_note
                           A   877    	XDEF _init_speaker
                           A   878    	XDEF _duration_cutoff
                           A   879    	XDEF _duration_timer
                           A   880    	XDEF _note_values
                           A   881    	END
ZiLOG ZNEO Macro Assembler Version 1.10 (07022203)                                               21-Feb-11     01:25:10     page:  18


PC     Object              I  Line    Source 


Errors: 0
Warnings: 0
Lines Assembled: 882
