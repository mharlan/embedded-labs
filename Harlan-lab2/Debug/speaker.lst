ZiLOG ZNEO Macro Assembler Version 1.10 (07022203)                                               22-Feb-11     21:39:12     page:   1


PC     Object              I  Line    Source 
                           A     1    ; ZiLOG ZNEO ANSI C Compiler Release 1.11
                           A     2    ; -nolocalcse -optsize -model=S -nomodsect -noregvar
                           A     3    ; -reduceopt -debug -peephole -const=ROM -alias -fastcall
                           A     4    	FILE	"..\SPEAKER.C"
                           A     5    .debug "C"
                           A     6    	SEGMENT NEAR_DATA
00000000                   A     7    _note_values:
00000000 00000106          A     8    	DL	262
00000004 00000115          A     9    	DL	277
00000008 00000126          A    10    	DL	294
0000000C 00000137          A    11    	DL	311
00000010 0000014A          A    12    	DL	330
00000014 0000015D          A    13    	DL	349
00000018 00000172          A    14    	DL	370
0000001C 00000188          A    15    	DL	392
00000020 0000019F          A    16    	DL	415
00000024 000001B8          A    17    	DL	440
00000028 000001D2          A    18    	DL	466
0000002C 000001EE          A    19    	DL	494
00000030 0000020B          A    20    	DL	523
00000034 0000022A          A    21    	DL	554
00000038 0000024B          A    22    	DL	587
0000003C 0000026E          A    23    	DL	622
00000040 00000293          A    24    	DL	659
00000044 000002BA          A    25    	DL	698
00000048 000002E4          A    26    	DL	740
0000004C 00000310          A    27    	DL	784
00000050 0000033F          A    28    	DL	831
00000054 00000370          A    29    	DL	880
00000058 000003A4          A    30    	DL	932
0000005C 000003DC          A    31    	DL	988
00000060 00000417          A    32    	DL	1047
00000064 00000455          A    33    	DL	1109
00000068 00000497          A    34    	DL	1175
0000006C 000004DD          A    35    	DL	1245
00000070 00000527          A    36    	DL	1319
00000074 00000575          A    37    	DL	1397
00000078 000005C8          A    38    	DL	1480
0000007C 00000620          A    39    	DL	1568
00000080 0000067D          A    40    	DL	1661
00000084 000006E0          A    41    	DL	1760
00000088 00000749          A    42    	DL	1865
0000008C 000007B8          A    43    	DL	1976
00000090 0000082D          A    44    	DL	2093
00000094 000008A9          A    45    	DL	2217
00000098 0000092D          A    46    	DL	2349
0000009C 000009B9          A    47    	DL	2489
000000A0 00000A4D          A    48    	DL	2637
000000A4 00000AEA          A    49    	DL	2794
000000A8 00000B90          A    50    	DL	2960
000000AC 00000C40          A    51    	DL	3136
000000B0 00000CFA          A    52    	DL	3322
ZiLOG ZNEO Macro Assembler Version 1.10 (07022203)                                               22-Feb-11     21:39:12     page:   2


PC     Object              I  Line    Source speaker.src
000000B4 00000DC0          A    53    	DL	3520
000000B8 00000E91          A    54    	DL	3729
000000BC 00000F6F          A    55    	DL	3951
                           A    56    .define "note_values"
                           A    57    .alias "_note_values"
                           A    58    .class 133
                           A    59    .value _note_values
                           A    60    .dim 4
                           A    61    .dim 12
                           A    62    .type 879
                           A    63    .type 0
                           A    64    .endef
                           A    65    	SEGMENT NEAR_BSS
00000000                   A    66    _duration_timer:
00000000                   A    67    	DS 4*1
                           A    68    .define "duration_timer"
                           A    69    .alias "_duration_timer"
                           A    70    .class 147
                           A    71    .value _duration_timer
                           A    72    .type 6
                           A    73    .type 0
                           A    74    .endef
00000004                   A    75    _duration_cutoff:
00000004                   A    76    	DS 4*1
                           A    77    .define "duration_cutoff"
                           A    78    .alias "_duration_cutoff"
                           A    79    .class 147
                           A    80    .value _duration_cutoff
                           A    81    .type 6
                           A    82    .type 0
                           A    83    .endef
                           A    84    ;    1	#include "speaker.h"
                           A    85    ;    2	#include "timer.h"
                           A    86    ;    3	#include "notes.h"
                           A    87    ;    4	#include "timer.h"
                           A    88    ;    5	#include "rttl.h"
                           A    89    ;    6	#include "oscillator.h"
                           A    90    ;    7	
                           A    91    ;    8	#include <zneo.h>
                           A    92    ;    9	#include <string.h>
                           A    93    ;   10	#include <ctype.h>
                           A    94    ;   11	
                           A    95    ;   12	static float duration_timer;
                           A    96    ;   13	static float duration_cutoff;
                           A    97    	SEGMENT CODE
                           A    98    ;   14	
                           A    99    ;   15	static void play_note(int octave, unsigned char note[3], int duration, int bpm);
                           A   100    ;   16	static void stop_note(void);
                           A   101    ;   17	static void stop_ringtone(void);
                           A   102    ;   18	static void disable_speaker_timer(void);
                           A   103    ;   19	static void init_speaker_timer(void);
                           A   104    ;   20	static void start_speaker_timer(unsigned int frequency);
ZiLOG ZNEO Macro Assembler Version 1.10 (07022203)                                               22-Feb-11     21:39:12     page:   3


PC     Object              I  Line    Source speaker.src
                           A   105    ;   21	static float beats_to_duration(int beats, int bpm);
                           A   106    ;   22	
                           A   107    ;   23	/*
                           A   108    ;   24		Initialize the speaker IO ports.
                           A   109    ;   25	
                           A   110    ;   26		Ground:PC0
                           A   111    ;   27		GPIO:PC1 (timer1 output)
                           A   112    ;   28	 */
                           A   113    ;   29	void init_speaker(void)
                           A   114    ;   30	{
00000000                   A   115    _init_speaker:
                           A   116    .define "_init_speaker"
                           A   117    .value _init_speaker
                           A   118    .class 2
                           A   119    .type 65
                           A   120    .type 0
                           A   121    .endef
                           A   122    .begfunc "init_speaker",30,"_init_speaker"
00000000 0800              A   123    	LINK	#0
                           A   124    ;   31		PCDD &= ~0x03;	//set PC0 and PC1 as outputs
                           A   125    .line 31
00000002 30FC              A   126    	LD	R0,#-4
00000004 7250 E122         A   127    	AND.B	57634:RAM,R0
                           A   128    ;   32		PCOUT &= ~0x03; //set PC0 and PC1 low
                           A   129    .line 32
00000008 7250 E121         A   130    	AND.B	57633:RAM,R0
                           A   131    ;   33	
                           A   132    ;   34		duration_timer = 0;
                           A   133    .line 34
0000000C ADA8 0000         A   134    	CLR	_duration_timer:RAM
                           A   135    ;   35		duration_cutoff = 0;
                           A   136    .line 35
00000010 ADA8 0004         A   137    	CLR	_duration_cutoff:RAM
                           A   138    ;   36	
                           A   139    ;   37		init_speaker_timer();
                           A   140    .line 37
00000014 D12B              A   141    	CALL	_init_speaker_timer
                           A   142    ;   38	}
                           A   143    .line 38
00000016 0001              A   144    	UNLINK	
00000018 FFFC              A   145    	RET	
                           A   146    
                           A   147    
                           A   148    ;**************************** _init_speaker ***************************
                           A   149    ;Name                         Addr/Register   Size   Type
                           A   150    ;_init_speaker_timer                 STATIC  -----   function
                           A   151    ;_duration_cutoff                    STATIC      4   variable
                           A   152    ;_duration_timer                     STATIC      4   variable
                           A   153    
                           A   154    
                           A   155    ; Aggregate Stack Size: 0 (words)
                           A   156    
ZiLOG ZNEO Macro Assembler Version 1.10 (07022203)                                               22-Feb-11     21:39:12     page:   4


PC     Object              I  Line    Source speaker.src
                           A   157    
                           A   158    .endfunc "init_speaker",38,"_init_speaker"
                           A   159    ;   39	
                           A   160    ;   40	/*
                           A   161    ;   41		Handles all speaker events.
                           A   162    ;   42	 */
                           A   163    ;   43	void speaker_events(void)
                           A   164    ;   44	{
0000001A                   A   165    _speaker_events:
                           A   166    .define "_speaker_events"
                           A   167    .value _speaker_events
                           A   168    .class 2
                           A   169    .type 65
                           A   170    .type 0
                           A   171    .endef
                           A   172    .begfunc "speaker_events",44,"_speaker_events"
0000001A 0800              A   173    	LINK	#0
0000001C 05C0              A   174    	PUSHMHI	#3
                           A   175    ;   45		if(duration_cutoff) {
                           A   176    .line 45
0000001E 3900              A   177    	LD	R9,#0
00000020 0348 0004         A   178    	LD	R8,_duration_cutoff:RAM
00000024 F1 FFFFEC         A   179    	CALL	__fpcmp
00000028 E6 13             A   180    	JP	EQ,_2_L_3
                           A   181    ;   46			duration_timer += timer_interval_float();
                           A   182    .line 46
0000002A F1 FFFFE9         A   183    	CALL	_timer_interval_float
0000002E 4408              A   184    	LD	R8,R0
00000030 0349 0000         A   185    	LD	R9,_duration_timer:RAM
00000034 F1 FFFFE4         A   186    	CALL	__fpadd
00000038 0370 0000         A   187    	LD	_duration_timer:RAM,R0
                           A   188    ;   47			
                           A   189    ;   48			if(duration_timer >= duration_cutoff) {
                           A   190    .line 48
0000003C 0349 0004         A   191    	LD	R9,_duration_cutoff:RAM
00000040 0348 0000         A   192    	LD	R8,_duration_timer:RAM
00000044 F1 FFFFDC         A   193    	CALL	__fpcmp
00000048 E1 03             A   194    	JP	LT,_2_L_3
                           A   195    ;   49				disable_speaker_timer();
                           A   196    .line 49
0000004A D005              A   197    	CALL	_disable_speaker_timer
                           A   198    ;   50			
                           A   199    ;   51				play_next_note();
                           A   200    .line 51
0000004C F1 FFFFD8         A   201    	CALL	_play_next_note
                           A   202    ;   52			}
                           A   203    ;   53		}
                           A   204    ;   54	}
00000050                   A   205    _2_L_3:
                           A   206    .line 54
00000050 0703              A   207    	POPMHI	#3
00000052 0001              A   208    	UNLINK	
ZiLOG ZNEO Macro Assembler Version 1.10 (07022203)                                               22-Feb-11     21:39:12     page:   5


PC     Object              I  Line    Source speaker.src
00000054 FFFC              A   209    	RET	
                           A   210    
                           A   211    
                           A   212    ;**************************** _speaker_events ***************************
                           A   213    ;Name                         Addr/Register   Size   Type
                           A   214    ;_play_next_note                     IMPORT  -----   function
                           A   215    ;_disable_speaker_timer              STATIC  -----   function
                           A   216    ;_duration_timer                     STATIC      4   variable
                           A   217    ;_timer_interval_float               IMPORT  -----   function
                           A   218    ;_duration_cutoff                    STATIC      4   variable
                           A   219    
                           A   220    
                           A   221    ; Aggregate Stack Size: 0 (words)
                           A   222    
                           A   223    
                           A   224    .endfunc "speaker_events",54,"_speaker_events"
                           A   225    ;   55	
                           A   226    ;   56	/*
                           A   227    ;   57		Disables timer1 and sets PC1 low.
                           A   228    ;   58	 */
                           A   229    ;   59	void disable_speaker_timer(void)
                           A   230    ;   60	{
00000056                   A   231    _disable_speaker_timer:
                           A   232    .define "_disable_speaker_timer"
                           A   233    .value _disable_speaker_timer
                           A   234    .class 2
                           A   235    .type 65
                           A   236    .type 0
                           A   237    .endef
                           A   238    .begfunc "disable_speaker_timer",60,"_disable_speaker_timer"
00000056 0800              A   239    	LINK	#0
                           A   240    ;   61		duration_cutoff = 0;
                           A   241    .line 61
00000058 ADA8 0004         A   242    	CLR	_duration_cutoff:RAM
                           A   243    ;   62		duration_timer = 0;
                           A   244    .line 62
0000005C ADA8 0000         A   245    	CLR	_duration_timer:RAM
                           A   246    ;   63	
                           A   247    ;   64		T1CTL1 |= TIMER_DISABLE;
                           A   248    .line 64
00000060 0310 E317         A   249    	LD.SB	R0,58135:RAM
                           A   250    ;   65		PCOUT &= ~0x02;	//set PC1 low
                           A   251    .line 65
00000064 30FD              A   252    	LD	R0,#-3
00000066 7250 E121         A   253    	AND.B	57633:RAM,R0
                           A   254    ;   66		PCAF &= ~0x02;
                           A   255    .line 66
0000006A 7260 E124         A   256    	AND.W	57636:RAM,R0
                           A   257    ;   67	}
                           A   258    .line 67
0000006E 0001              A   259    	UNLINK	
00000070 FFFC              A   260    	RET	
ZiLOG ZNEO Macro Assembler Version 1.10 (07022203)                                               22-Feb-11     21:39:12     page:   6


PC     Object              I  Line    Source speaker.src
                           A   261    
                           A   262    
                           A   263    ;**************************** _disable_speaker_timer ***************************
                           A   264    ;Name                         Addr/Register   Size   Type
                           A   265    ;_duration_timer                     STATIC      4   variable
                           A   266    ;_duration_cutoff                    STATIC      4   variable
                           A   267    
                           A   268    
                           A   269    ; Aggregate Stack Size: 0 (words)
                           A   270    
                           A   271    
                           A   272    .endfunc "disable_speaker_timer",67,"_disable_speaker_timer"
                           A   273    	SEGMENT ROM_TEXT
00000000                   A   274    L__6:
00000000 61                A   275    	DB	"a"
00000001 00                A   276    	DB	0
00000002                   A   277    L__8:
00000002 6123              A   278    	DB	"a#"
00000004 00                A   279    	DB	0
00000005                   A   280    L__10:
00000005 62                A   281    	DB	"b"
00000006 00                A   282    	DB	0
00000007                   A   283    L__12:
00000007 63                A   284    	DB	"c"
00000008 00                A   285    	DB	0
00000009                   A   286    L__14:
00000009 6323              A   287    	DB	"c#"
0000000B 00                A   288    	DB	0
0000000C                   A   289    L__16:
0000000C 64                A   290    	DB	"d"
0000000D 00                A   291    	DB	0
0000000E                   A   292    L__18:
0000000E 6423              A   293    	DB	"d#"
00000010 00                A   294    	DB	0
00000011                   A   295    L__20:
00000011 65                A   296    	DB	"e"
00000012 00                A   297    	DB	0
00000013                   A   298    L__22:
00000013 66                A   299    	DB	"f"
00000014 00                A   300    	DB	0
00000015                   A   301    L__24:
00000015 6623              A   302    	DB	"f#"
00000017 00                A   303    	DB	0
00000018                   A   304    L__26:
00000018 67                A   305    	DB	"g"
00000019 00                A   306    	DB	0
0000001A                   A   307    L__28:
0000001A 6723              A   308    	DB	"g#"
0000001C 00                A   309    	DB	0
                           A   310    	SEGMENT CODE
                           A   311    ;   68	
                           A   312    ;   69	/*
ZiLOG ZNEO Macro Assembler Version 1.10 (07022203)                                               22-Feb-11     21:39:12     page:   7


PC     Object              I  Line    Source speaker.src
                           A   313    ;   70		Play a note in a given octave for a given duration on the speaker.
                           A   314    ;   71	 */
                           A   315    ;   72	void play_note(int octave, unsigned char note[3], int duration, int bpm)
                           A   316    ;   73	{
00000072                   A   317    _play_note:
                           A   318    .define "_play_note"
                           A   319    .value _play_note
                           A   320    .class 2
                           A   321    .type 65
                           A   322    .type 0
                           A   323    .endef
                           A   324    .begfunc "play_note",73,"_play_note"
00000072 080E              A   325    	LINK	#14
                           A   326    .line 73
00000074 5BC1              A   327    	LD	-4(R14),R1
                           A   328    .define "octave"
                           A   329    .class 9
                           A   330    .value -4
                           A   331    .type 5
                           A   332    .type 0
                           A   333    .endef
00000076 57A2              A   334    	LD.W	-6(R14),R2
                           A   335    .define "note"
                           A   336    .class 9
                           A   337    .value -6
                           A   338    .type 140
                           A   339    .type 0
                           A   340    .endef
00000078 5B63              A   341    	LD	-10(R14),R3
                           A   342    .define "duration"
                           A   343    .class 9
                           A   344    .value -10
                           A   345    .type 5
                           A   346    .type 0
                           A   347    .endef
0000007A 5B24              A   348    	LD	-14(R14),R4
                           A   349    .define "bpm"
                           A   350    .class 9
                           A   351    .value -14
                           A   352    .type 5
                           A   353    .type 0
                           A   354    .endef
                           A   355    ;   74		//if not lowercase, make lowercase
                           A   356    ;   75		if(!islower(note[0])) {
                           A   357    .line 75
0000007C 6FA0              A   358    	LD.SW	R0,-6(R14)
0000007E 1801              A   359    	LD.UB	R1,(R0)
00000080 F1 FFFFBE         A   360    	CALL	_islower
00000084 9000              A   361    	CP	R0,#0
00000086 EE 06             A   362    	JP	NE,_4_L_29
                           A   363    ;   76			note[0] = tolower(note[0]);
                           A   364    .line 76
ZiLOG ZNEO Macro Assembler Version 1.10 (07022203)                                               22-Feb-11     21:39:12     page:   8


PC     Object              I  Line    Source speaker.src
00000088 6FA0              A   365    	LD.SW	R0,-6(R14)
0000008A 1801              A   366    	LD.UB	R1,(R0)
0000008C F1 FFFFB8         A   367    	CALL	_tolower
00000090 6FA1              A   368    	LD.SW	R1,-6(R14)
00000092 0E01              A   369    	LD.B	(R1),R0
                           A   370    ;   77		}
00000094                   A   371    _4_L_29:
                           A   372    .line 77
                           A   373    ;   78	
                           A   374    ;   79		//figure out what note it is
                           A   375    ;   80		if(!strncmp(note, "a", 2)) {
                           A   376    .line 80
00000094 6FA1              A   377    	LD.SW	R1,-6(R14)
00000096 4502 0000         A   378    	LD	R2,#L__6
0000009A 3302              A   379    	LD	R3,#2
0000009C F1 FFFFB0         A   380    	CALL	_strncmp
000000A0 9000              A   381    	CP	R0,#0
000000A2 EE 0B             A   382    	JP	NE,_4_L_28
                           A   383    ;   81			start_speaker_timer(note_values[octave - NUM_OCTAVES][NOTE_A]);
                           A   384    .line 81
000000A4 5FC0              A   385    	LD	R0,-4(R14)
000000A6 80FC              A   386    	ADD	R0,#-4
000000A8 3130              A   387    	LD	R1,#48
000000AA B110              A   388    	SMUL	R0,R1
000000AC 4511 0000         A   389    	LD	R1,#_note_values
000000B0 A010              A   390    	ADD	R0,R1
000000B2 4801 0028         A   391    	LD	R1,40(R0)
000000B6 D0E2              A   392    	CALL	_start_speaker_timer
                           A   393    ;   82		}
                           A   394    ;   83		else if(!strncmp(note, "a#", 2))
                           A   395    .line 83
000000B8 C0D0              A   396    	JP	_4_L_30
000000BA                   A   397    _4_L_28:
000000BA 6FA1              A   398    	LD.SW	R1,-6(R14)
000000BC 4502 0002         A   399    	LD	R2,#L__8
000000C0 3302              A   400    	LD	R3,#2
000000C2 F1 FFFF9D         A   401    	CALL	_strncmp
000000C6 9000              A   402    	CP	R0,#0
000000C8 EE 0B             A   403    	JP	NE,_4_L_26
                           A   404    ;   84		{
                           A   405    ;   85			start_speaker_timer(note_values[octave - NUM_OCTAVES][NOTE_ASHARP]);
                           A   406    .line 85
000000CA 5FC0              A   407    	LD	R0,-4(R14)
000000CC 80FC              A   408    	ADD	R0,#-4
000000CE 3130              A   409    	LD	R1,#48
000000D0 B110              A   410    	SMUL	R0,R1
000000D2 4511 0000         A   411    	LD	R1,#_note_values
000000D6 A010              A   412    	ADD	R0,R1
000000D8 4801 002C         A   413    	LD	R1,44(R0)
000000DC D0CF              A   414    	CALL	_start_speaker_timer
                           A   415    ;   86		}
                           A   416    ;   87		else if(!strncmp(note, "b", 2))
ZiLOG ZNEO Macro Assembler Version 1.10 (07022203)                                               22-Feb-11     21:39:12     page:   9


PC     Object              I  Line    Source speaker.src
                           A   417    .line 87
000000DE C0BD              A   418    	JP	_4_L_30
000000E0                   A   419    _4_L_26:
000000E0 6FA1              A   420    	LD.SW	R1,-6(R14)
000000E2 4502 0005         A   421    	LD	R2,#L__10
000000E6 3302              A   422    	LD	R3,#2
000000E8 F1 FFFF8A         A   423    	CALL	_strncmp
000000EC 9000              A   424    	CP	R0,#0
000000EE EE 0B             A   425    	JP	NE,_4_L_24
                           A   426    ;   88		{
                           A   427    ;   89			start_speaker_timer(note_values[octave - NUM_OCTAVES][NOTE_B]);
                           A   428    .line 89
000000F0 5FC0              A   429    	LD	R0,-4(R14)
000000F2 80FC              A   430    	ADD	R0,#-4
000000F4 3130              A   431    	LD	R1,#48
000000F6 B110              A   432    	SMUL	R0,R1
000000F8 4511 0000         A   433    	LD	R1,#_note_values
000000FC A010              A   434    	ADD	R0,R1
000000FE 4801 0030         A   435    	LD	R1,48(R0)
00000102 D0BC              A   436    	CALL	_start_speaker_timer
                           A   437    ;   90		}
                           A   438    ;   91		else if(!strncmp(note, "c", 2))
                           A   439    .line 91
00000104 C0AA              A   440    	JP	_4_L_30
00000106                   A   441    _4_L_24:
00000106 6FA1              A   442    	LD.SW	R1,-6(R14)
00000108 4502 0007         A   443    	LD	R2,#L__12
0000010C 3302              A   444    	LD	R3,#2
0000010E F1 FFFF77         A   445    	CALL	_strncmp
00000112 9000              A   446    	CP	R0,#0
00000114 EE 0B             A   447    	JP	NE,_4_L_22
                           A   448    ;   92		{
                           A   449    ;   93			start_speaker_timer(note_values[octave - NUM_OCTAVES][NOTE_C]);
                           A   450    .line 93
00000116 5FC0              A   451    	LD	R0,-4(R14)
00000118 80FC              A   452    	ADD	R0,#-4
0000011A 3130              A   453    	LD	R1,#48
0000011C B110              A   454    	SMUL	R0,R1
0000011E 4511 0000         A   455    	LD	R1,#_note_values
00000122 A010              A   456    	ADD	R0,R1
00000124 4801 0004         A   457    	LD	R1,4(R0)
00000128 D0A9              A   458    	CALL	_start_speaker_timer
                           A   459    ;   94		}
                           A   460    ;   95		else if(!strncmp(note, "c#", 2))
                           A   461    .line 95
0000012A C097              A   462    	JP	_4_L_30
0000012C                   A   463    _4_L_22:
0000012C 6FA1              A   464    	LD.SW	R1,-6(R14)
0000012E 4502 0009         A   465    	LD	R2,#L__14
00000132 3302              A   466    	LD	R3,#2
00000134 F1 FFFF64         A   467    	CALL	_strncmp
00000138 9000              A   468    	CP	R0,#0
ZiLOG ZNEO Macro Assembler Version 1.10 (07022203)                                               22-Feb-11     21:39:12     page:  10


PC     Object              I  Line    Source speaker.src
0000013A EE 0B             A   469    	JP	NE,_4_L_20
                           A   470    ;   96		{
                           A   471    ;   97			start_speaker_timer(note_values[octave - NUM_OCTAVES][NOTE_CSHARP]);
                           A   472    .line 97
0000013C 5FC0              A   473    	LD	R0,-4(R14)
0000013E 80FC              A   474    	ADD	R0,#-4
00000140 3130              A   475    	LD	R1,#48
00000142 B110              A   476    	SMUL	R0,R1
00000144 4511 0000         A   477    	LD	R1,#_note_values
00000148 A010              A   478    	ADD	R0,R1
0000014A 4801 0008         A   479    	LD	R1,8(R0)
0000014E D096              A   480    	CALL	_start_speaker_timer
                           A   481    ;   98		}
                           A   482    ;   99		else if(!strncmp(note, "d", 2))
                           A   483    .line 99
00000150 C084              A   484    	JP	_4_L_30
00000152                   A   485    _4_L_20:
00000152 6FA1              A   486    	LD.SW	R1,-6(R14)
00000154 4502 000C         A   487    	LD	R2,#L__16
00000158 3302              A   488    	LD	R3,#2
0000015A F1 FFFF51         A   489    	CALL	_strncmp
0000015E 9000              A   490    	CP	R0,#0
00000160 EE 0B             A   491    	JP	NE,_4_L_18
                           A   492    ;  100		{
                           A   493    ;  101			start_speaker_timer(note_values[octave - NUM_OCTAVES][NOTE_D]);
                           A   494    .line 101
00000162 5FC0              A   495    	LD	R0,-4(R14)
00000164 80FC              A   496    	ADD	R0,#-4
00000166 3130              A   497    	LD	R1,#48
00000168 B110              A   498    	SMUL	R0,R1
0000016A 4511 0000         A   499    	LD	R1,#_note_values
0000016E A010              A   500    	ADD	R0,R1
00000170 4801 000C         A   501    	LD	R1,12(R0)
00000174 D083              A   502    	CALL	_start_speaker_timer
                           A   503    ;  102		}
                           A   504    ;  103		else if(!strncmp(note, "d#", 2))
                           A   505    .line 103
00000176 C071              A   506    	JP	_4_L_30
00000178                   A   507    _4_L_18:
00000178 6FA1              A   508    	LD.SW	R1,-6(R14)
0000017A 4502 000E         A   509    	LD	R2,#L__18
0000017E 3302              A   510    	LD	R3,#2
00000180 F1 FFFF3E         A   511    	CALL	_strncmp
00000184 9000              A   512    	CP	R0,#0
00000186 EE 0B             A   513    	JP	NE,_4_L_16
                           A   514    ;  104		{
                           A   515    ;  105			start_speaker_timer(note_values[octave - NUM_OCTAVES][NOTE_DSHARP]);
                           A   516    .line 105
00000188 5FC0              A   517    	LD	R0,-4(R14)
0000018A 80FC              A   518    	ADD	R0,#-4
0000018C 3130              A   519    	LD	R1,#48
0000018E B110              A   520    	SMUL	R0,R1
ZiLOG ZNEO Macro Assembler Version 1.10 (07022203)                                               22-Feb-11     21:39:12     page:  11


PC     Object              I  Line    Source speaker.src
00000190 4511 0000         A   521    	LD	R1,#_note_values
00000194 A010              A   522    	ADD	R0,R1
00000196 4801 0010         A   523    	LD	R1,16(R0)
0000019A D070              A   524    	CALL	_start_speaker_timer
                           A   525    ;  106		}
                           A   526    ;  107		else if(!strncmp(note, "e", 2))
                           A   527    .line 107
0000019C C05E              A   528    	JP	_4_L_30
0000019E                   A   529    _4_L_16:
0000019E 6FA1              A   530    	LD.SW	R1,-6(R14)
000001A0 4502 0011         A   531    	LD	R2,#L__20
000001A4 3302              A   532    	LD	R3,#2
000001A6 F1 FFFF2B         A   533    	CALL	_strncmp
000001AA 9000              A   534    	CP	R0,#0
000001AC EE 0B             A   535    	JP	NE,_4_L_14
                           A   536    ;  108		{
                           A   537    ;  109			start_speaker_timer(note_values[octave - NUM_OCTAVES][NOTE_E]);
                           A   538    .line 109
000001AE 5FC0              A   539    	LD	R0,-4(R14)
000001B0 80FC              A   540    	ADD	R0,#-4
000001B2 3130              A   541    	LD	R1,#48
000001B4 B110              A   542    	SMUL	R0,R1
000001B6 4511 0000         A   543    	LD	R1,#_note_values
000001BA A010              A   544    	ADD	R0,R1
000001BC 4801 0014         A   545    	LD	R1,20(R0)
000001C0 D05D              A   546    	CALL	_start_speaker_timer
                           A   547    ;  110		}
                           A   548    ;  111		else if(!strncmp(note, "f", 2))
                           A   549    .line 111
000001C2 C04B              A   550    	JP	_4_L_30
000001C4                   A   551    _4_L_14:
000001C4 6FA1              A   552    	LD.SW	R1,-6(R14)
000001C6 4502 0013         A   553    	LD	R2,#L__22
000001CA 3302              A   554    	LD	R3,#2
000001CC F1 FFFF18         A   555    	CALL	_strncmp
000001D0 9000              A   556    	CP	R0,#0
000001D2 EE 0B             A   557    	JP	NE,_4_L_12
                           A   558    ;  112		{
                           A   559    ;  113			start_speaker_timer(note_values[octave - NUM_OCTAVES][NOTE_F]);
                           A   560    .line 113
000001D4 5FC0              A   561    	LD	R0,-4(R14)
000001D6 80FC              A   562    	ADD	R0,#-4
000001D8 3130              A   563    	LD	R1,#48
000001DA B110              A   564    	SMUL	R0,R1
000001DC 4511 0000         A   565    	LD	R1,#_note_values
000001E0 A010              A   566    	ADD	R0,R1
000001E2 4801 0018         A   567    	LD	R1,24(R0)
000001E6 D04A              A   568    	CALL	_start_speaker_timer
                           A   569    ;  114		}
                           A   570    ;  115		else if(!strncmp(note, "f#", 2))
                           A   571    .line 115
000001E8 C038              A   572    	JP	_4_L_30
ZiLOG ZNEO Macro Assembler Version 1.10 (07022203)                                               22-Feb-11     21:39:12     page:  12


PC     Object              I  Line    Source speaker.src
000001EA                   A   573    _4_L_12:
000001EA 6FA1              A   574    	LD.SW	R1,-6(R14)
000001EC 4502 0015         A   575    	LD	R2,#L__24
000001F0 3302              A   576    	LD	R3,#2
000001F2 F1 FFFF05         A   577    	CALL	_strncmp
000001F6 9000              A   578    	CP	R0,#0
000001F8 EE 0B             A   579    	JP	NE,_4_L_10
                           A   580    ;  116		{
                           A   581    ;  117			start_speaker_timer(note_values[octave - NUM_OCTAVES][NOTE_FSHARP]);
                           A   582    .line 117
000001FA 5FC0              A   583    	LD	R0,-4(R14)
000001FC 80FC              A   584    	ADD	R0,#-4
000001FE 3130              A   585    	LD	R1,#48
00000200 B110              A   586    	SMUL	R0,R1
00000202 4511 0000         A   587    	LD	R1,#_note_values
00000206 A010              A   588    	ADD	R0,R1
00000208 4801 001C         A   589    	LD	R1,28(R0)
0000020C D037              A   590    	CALL	_start_speaker_timer
                           A   591    ;  118		}
                           A   592    ;  119		else if(!strncmp(note, "g", 2))
                           A   593    .line 119
0000020E C025              A   594    	JP	_4_L_30
00000210                   A   595    _4_L_10:
00000210 6FA1              A   596    	LD.SW	R1,-6(R14)
00000212 4502 0018         A   597    	LD	R2,#L__26
00000216 3302              A   598    	LD	R3,#2
00000218 F1 FFFEF2         A   599    	CALL	_strncmp
0000021C 9000              A   600    	CP	R0,#0
0000021E EE 0B             A   601    	JP	NE,_4_L_8
                           A   602    ;  120		{
                           A   603    ;  121			start_speaker_timer(note_values[octave - NUM_OCTAVES][NOTE_G]);
                           A   604    .line 121
00000220 5FC0              A   605    	LD	R0,-4(R14)
00000222 80FC              A   606    	ADD	R0,#-4
00000224 3130              A   607    	LD	R1,#48
00000226 B110              A   608    	SMUL	R0,R1
00000228 4511 0000         A   609    	LD	R1,#_note_values
0000022C A010              A   610    	ADD	R0,R1
0000022E 4801 0020         A   611    	LD	R1,32(R0)
00000232 D024              A   612    	CALL	_start_speaker_timer
                           A   613    ;  122		}
                           A   614    ;  123		else if(!strncmp(note, "g#", 2))
                           A   615    .line 123
00000234 C012              A   616    	JP	_4_L_30
00000236                   A   617    _4_L_8:
00000236 6FA1              A   618    	LD.SW	R1,-6(R14)
00000238 4502 001A         A   619    	LD	R2,#L__28
0000023C 3302              A   620    	LD	R3,#2
0000023E F1 FFFEDF         A   621    	CALL	_strncmp
00000242 9000              A   622    	CP	R0,#0
00000244 EE 0A             A   623    	JP	NE,_4_L_30
                           A   624    ;  124		{
ZiLOG ZNEO Macro Assembler Version 1.10 (07022203)                                               22-Feb-11     21:39:12     page:  13


PC     Object              I  Line    Source speaker.src
                           A   625    ;  125			start_speaker_timer(note_values[octave - NUM_OCTAVES][NOTE_GSHARP]);
                           A   626    .line 125
00000246 5FC0              A   627    	LD	R0,-4(R14)
00000248 80FC              A   628    	ADD	R0,#-4
0000024A 3130              A   629    	LD	R1,#48
0000024C B110              A   630    	SMUL	R0,R1
0000024E 4511 0000         A   631    	LD	R1,#_note_values
00000252 A010              A   632    	ADD	R0,R1
00000254 4801 0024         A   633    	LD	R1,36(R0)
00000258 D011              A   634    	CALL	_start_speaker_timer
                           A   635    ;  126		}
0000025A                   A   636    _4_L_30:
                           A   637    .line 126
                           A   638    ;  127	
                           A   639    ;  128		//set timer for duration of note
                           A   640    ;  129		duration_timer = 0;
                           A   641    .line 129
0000025A ADA8 0000         A   642    	CLR	_duration_timer:RAM
                           A   643    ;  130		duration_cutoff = beats_to_duration(duration, bpm);
                           A   644    .line 130
0000025E 5F61              A   645    	LD	R1,-10(R14)
00000260 5F22              A   646    	LD	R2,-14(R14)
00000262 D035              A   647    	CALL	_beats_to_duration
00000264 0370 0004         A   648    	LD	_duration_cutoff:RAM,R0
                           A   649    ;  131	}
                           A   650    .line 131
00000268 0001              A   651    	UNLINK	
0000026A FFFC              A   652    	RET	
                           A   653    
                           A   654    
                           A   655    ;**************************** _play_note ***************************
                           A   656    ;Name                         Addr/Register   Size   Type
                           A   657    ;_duration_cutoff                    STATIC      4   variable
                           A   658    ;_beats_to_duration                  STATIC  -----   function
                           A   659    ;_duration_timer                     STATIC      4   variable
                           A   660    ;_note_values                        STATIC    192   variable
                           A   661    ;_start_speaker_timer                STATIC  -----   function
                           A   662    ;_strncmp                            IMPORT  -----   function
                           A   663    ;_tolower                            IMPORT  -----   function
                           A   664    ;_islower                            IMPORT  -----   function
                           A   665    ;bpm                                 R14-14      4   parameter
                           A   666    ;duration                            R14-10      4   parameter
                           A   667    ;note                                 R14-6      2   parameter
                           A   668    ;octave                               R14-4      4   parameter
                           A   669    
                           A   670    
                           A   671    ; Aggregate Stack Size: -14 (words)
                           A   672    
                           A   673    
                           A   674    .endfunc "play_note",131,"_play_note"
                           A   675    ;  132	
                           A   676    ;  133	/*
ZiLOG ZNEO Macro Assembler Version 1.10 (07022203)                                               22-Feb-11     21:39:12     page:  14


PC     Object              I  Line    Source speaker.src
                           A   677    ;  134		Setup timer1.
                           A   678    ;  135	 */
                           A   679    ;  136	static void init_speaker_timer(void)
                           A   680    ;  137	{
0000026C                   A   681    _init_speaker_timer:
                           A   682    .define "_init_speaker_timer"
                           A   683    .value _init_speaker_timer
                           A   684    .class 3
                           A   685    .type 65
                           A   686    .type 0
                           A   687    .endef
                           A   688    .begfunc "init_speaker_timer",137,"_init_speaker_timer"
0000026C 0800              A   689    	LINK	#0
                           A   690    ;  138		T1CTL1 |= TIMER_DISABLE;
                           A   691    .line 138
0000026E 0310 E317         A   692    	LD.SB	R0,58135:RAM
                           A   693    ;  139	
                           A   694    ;  140	    T1CTL1 = TIMER_MODE_CONTINUOUS + TIMER_PRESCALE_64;
                           A   695    .line 140
00000272 3031              A   696    	LD	R0,#49
00000274 0350 E317         A   697    	LD.B	58135:RAM,R0
                           A   698    ;  141	}
                           A   699    .line 141
00000278 0001              A   700    	UNLINK	
0000027A FFFC              A   701    	RET	
                           A   702    
                           A   703    
                           A   704    ;**************************** _init_speaker_timer ***************************
                           A   705    ;Name                         Addr/Register   Size   Type
                           A   706    
                           A   707    
                           A   708    ; Aggregate Stack Size: 0 (words)
                           A   709    
                           A   710    
                           A   711    .endfunc "init_speaker_timer",141,"_init_speaker_timer"
                           A   712    ;  142	
                           A   713    ;  143	/*
                           A   714    ;  144	 	Enable timer 1. The timer will go off every
                           A   715    ;  145		1 / (2 * frequency) seconds.
                           A   716    ;  146	 */
                           A   717    ;  147	static void start_speaker_timer(unsigned int frequency)
                           A   718    ;  148	{
0000027C                   A   719    _start_speaker_timer:
                           A   720    .define "_start_speaker_timer"
                           A   721    .value _start_speaker_timer
                           A   722    .class 3
                           A   723    .type 65
                           A   724    .type 0
                           A   725    .endef
                           A   726    .begfunc "start_speaker_timer",148,"_start_speaker_timer"
0000027C 0808              A   727    	LINK	#8
0000027E 05C0              A   728    	PUSHMHI	#3
ZiLOG ZNEO Macro Assembler Version 1.10 (07022203)                                               22-Feb-11     21:39:12     page:  15


PC     Object              I  Line    Source speaker.src
                           A   729    .line 148
00000280 5BC1              A   730    	LD	-4(R14),R1
                           A   731    .define "frequency"
                           A   732    .class 9
                           A   733    .value -4
                           A   734    .type 15
                           A   735    .type 0
                           A   736    .endef
                           A   737    .define "timeout"
                           A   738    .class 1
                           A   739    .value -8
                           A   740    .type 6
                           A   741    .type 0
                           A   742    .endef
                           A   743    ;  149		float timeout;
                           A   744    ;  150	
                           A   745    ;  151		//calculate the timeout
                           A   746    ;  152		//timeout = 1.0f / (2.0f * (float)frequency);
                           A   747    ;  153		timeout = 1.0f / (float)frequency;
                           A   748    .line 153
00000282 5FC8              A   749    	LD	R8,-4(R14)
00000284 F1 FFFEBC         A   750    	CALL	__fpultof
00000288 4409              A   751    	LD	R9,R0
0000028A 4528 3F800000     A   752    	LD	R8,#1065353216
00000290 F1 FFFEB6         A   753    	CALL	__fpdiv
00000294 5B80              A   754    	LD	-8(R14),R0
                           A   755    ;  154	
                           A   756    ;  155		// Initial counter value
                           A   757    ;  156	    T1HL = 0x00;
                           A   758    .line 156
00000296 ADA4 E310         A   759    	CLR.W	58128:RAM
                           A   760    ;  157	
                           A   761    ;  158		// Timer reload
                           A   762    ;  159	    //   reload = clock / prescale * timeout  
                           A   763    ;  160	    T1R = get_osc_clock() / 64 * timeout;
                           A   764    .line 160
0000029A F1 FFFEB1         A   765    	CALL	_get_osc_clock
0000029E 3140              A   766    	LD	R1,#64
000002A0 AF10              A   767    	SDIV	R0,R1
000002A2 4408              A   768    	LD	R8,R0
000002A4 F1 FFFEAC         A   769    	CALL	__fpltof
000002A8 4408              A   770    	LD	R8,R0
000002AA 5F89              A   771    	LD	R9,-8(R14)
000002AC F1 FFFEA8         A   772    	CALL	__fpmul
000002B0 4408              A   773    	LD	R8,R0
000002B2 F1 FFFEA5         A   774    	CALL	__fpftol
000002B6 0360 E312         A   775    	LD.W	58130:RAM,R0
                           A   776    ;  161	
                           A   777    ;  162		// Enable Timer0 interrupt
                           A   778    ;  163	    //IRQ1EN = IRQ_Timer1;
                           A   779    ;  164	
                           A   780    ;  165		T1CTL1 |= TIMER_ENABLE;
ZiLOG ZNEO Macro Assembler Version 1.10 (07022203)                                               22-Feb-11     21:39:12     page:  16


PC     Object              I  Line    Source speaker.src
                           A   781    .line 165
000002BA 4500 0080         A   782    	LD	R0,#128
000002BE 7350 E317         A   783    	OR.B	58135:RAM,R0
                           A   784    ;  166	
                           A   785    ;  167		//set PC1 as T1OUT
                           A   786    ;  168		PCAF |= 0x02;
                           A   787    .line 168
000002C2 3002              A   788    	LD	R0,#2
000002C4 7360 E124         A   789    	OR.W	57636:RAM,R0
                           A   790    ;  169	}
                           A   791    .line 169
000002C8 0703              A   792    	POPMHI	#3
000002CA 0001              A   793    	UNLINK	
000002CC FFFC              A   794    	RET	
                           A   795    
                           A   796    
                           A   797    ;**************************** _start_speaker_timer ***************************
                           A   798    ;Name                         Addr/Register   Size   Type
                           A   799    ;_get_osc_clock                      IMPORT  -----   function
                           A   800    ;timeout                              R14-8      4   variable
                           A   801    ;frequency                            R14-4      4   parameter
                           A   802    
                           A   803    
                           A   804    ; Aggregate Stack Size: -8 (words)
                           A   805    
                           A   806    
                           A   807    .endfunc "start_speaker_timer",169,"_start_speaker_timer"
                           A   808    ;  170	
                           A   809    ;  171	/*
                           A   810    ;  172		Convert a duration to a time value using beats per minute.
                           A   811    ;  173	 */
                           A   812    ;  174	static float beats_to_duration(int beats, int bpm)
                           A   813    ;  175	{
000002CE                   A   814    _beats_to_duration:
                           A   815    .define "_beats_to_duration"
                           A   816    .value _beats_to_duration
                           A   817    .class 3
                           A   818    .type 70
                           A   819    .type 0
                           A   820    .endef
                           A   821    .begfunc "beats_to_duration",175,"_beats_to_duration"
                           A   822    .line 175
                           A   823    .define "beats"
                           A   824    .class 17
                           A   825    .reg 2
                           A   826    .type 5
                           A   827    .type 0
                           A   828    .endef
                           A   829    .define "bpm"
                           A   830    .class 17
                           A   831    .reg 3
                           A   832    .type 5
ZiLOG ZNEO Macro Assembler Version 1.10 (07022203)                                               22-Feb-11     21:39:12     page:  17


PC     Object              I  Line    Source speaker.src
                           A   833    .type 0
                           A   834    .endef
000002CE 0800              A   835    	LINK	#0
000002D0 05C0              A   836    	PUSHMHI	#3
                           A   837    ;  176		return (60.0f / (float)bpm) * (4.0f / (float)beats);
                           A   838    .line 176
000002D2 4428              A   839    	LD	R8,R2
000002D4 F1 FFFE94         A   840    	CALL	__fpltof
000002D8 4409              A   841    	LD	R9,R0
000002DA 4528 42700000     A   842    	LD	R8,#1114636288
000002E0 F1 FFFE8E         A   843    	CALL	__fpdiv
000002E4 4402              A   844    	LD	R2,R0
000002E6 4418              A   845    	LD	R8,R1
000002E8 F1 FFFE8A         A   846    	CALL	__fpltof
000002EC 4409              A   847    	LD	R9,R0
000002EE 4528 40800000     A   848    	LD	R8,#1082130432
000002F4 F1 FFFE84         A   849    	CALL	__fpdiv
000002F8 4428              A   850    	LD	R8,R2
000002FA 4409              A   851    	LD	R9,R0
000002FC F1 FFFE80         A   852    	CALL	__fpmul
                           A   853    ;  177	}
                           A   854    .line 177
00000300 0703              A   855    	POPMHI	#3
00000302 0001              A   856    	UNLINK	
00000304 FFFC              A   857    	RET	
                           A   858    
                           A   859    
                           A   860    ;**************************** _beats_to_duration ***************************
                           A   861    ;Name                         Addr/Register   Size   Type
                           A   862    ;bpm                                     R2      4   parameter
                           A   863    ;beats                                   R1      4   parameter
                           A   864    
                           A   865    
                           A   866    ; Aggregate Stack Size: 0 (words)
                           A   867    
                           A   868    
                           A   869    .endfunc "beats_to_duration",177,"_beats_to_duration"
                           A   870    	XREF _tolower:EROM
                           A   871    	XREF _islower:EROM
                           A   872    	XREF _strncmp:EROM
                           A   873    	XREF _get_osc_clock:EROM
                           A   874    	XREF _play_next_note:EROM
                           A   875    	XREF _timer_interval_float:EROM
                           A   876    	XREF __fpltof:EROM
                           A   877    	XREF __fpultof:EROM
                           A   878    	XREF __fpftol:EROM
                           A   879    	XREF __fpadd:EROM
                           A   880    	XREF __fpcmp:EROM
                           A   881    	XREF __fpdiv:EROM
                           A   882    	XREF __fpmul:EROM
                           A   883    	XDEF _play_note
                           A   884    	XDEF _disable_speaker_timer
ZiLOG ZNEO Macro Assembler Version 1.10 (07022203)                                               22-Feb-11     21:39:12     page:  18


PC     Object              I  Line    Source speaker.src
                           A   885    	XDEF _speaker_events
                           A   886    	XDEF _init_speaker
                           A   887    	XDEF _note_values
                           A   888    	END


Errors: 0
Warnings: 0
Lines Assembled: 889
