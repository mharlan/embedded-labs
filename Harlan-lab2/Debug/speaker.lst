ZiLOG ZNEO Macro Assembler Version 1.10 (07022203)                                               22-Feb-11     23:13:04     page:   1


PC     Object              I  Line    Source 
                           A     1    ; ZiLOG ZNEO ANSI C Compiler Release 1.11
                           A     2    ; -nolocalcse -optsize -model=S -nomodsect -noregvar
                           A     3    ; -reduceopt -debug -peephole -const=ROM -alias -fastcall
                           A     4    	FILE	"..\SPEAKER.C"
                           A     5    .debug "C"
                           A     6    	SEGMENT NEAR_DATA
00000000                   A     7    _note_values:
00000000 00000106          A     8    	DL	262
00000004 00000115          A     9    	DL	277
00000008 00000126          A    10    	DL	294
0000000C 00000137          A    11    	DL	311
00000010 0000014A          A    12    	DL	330
00000014 0000015D          A    13    	DL	349
00000018 00000172          A    14    	DL	370
0000001C 00000188          A    15    	DL	392
00000020 0000019F          A    16    	DL	415
00000024 000001B8          A    17    	DL	440
00000028 000001D2          A    18    	DL	466
0000002C 000001EE          A    19    	DL	494
00000030 0000020B          A    20    	DL	523
00000034 0000022A          A    21    	DL	554
00000038 0000024B          A    22    	DL	587
0000003C 0000026E          A    23    	DL	622
00000040 00000293          A    24    	DL	659
00000044 000002BA          A    25    	DL	698
00000048 000002E4          A    26    	DL	740
0000004C 00000310          A    27    	DL	784
00000050 0000033F          A    28    	DL	831
00000054 00000370          A    29    	DL	880
00000058 000003A4          A    30    	DL	932
0000005C 000003DC          A    31    	DL	988
00000060 00000417          A    32    	DL	1047
00000064 00000455          A    33    	DL	1109
00000068 00000497          A    34    	DL	1175
0000006C 000004DD          A    35    	DL	1245
00000070 00000527          A    36    	DL	1319
00000074 00000575          A    37    	DL	1397
00000078 000005C8          A    38    	DL	1480
0000007C 00000620          A    39    	DL	1568
00000080 0000067D          A    40    	DL	1661
00000084 000006E0          A    41    	DL	1760
00000088 00000749          A    42    	DL	1865
0000008C 000007B8          A    43    	DL	1976
00000090 0000082D          A    44    	DL	2093
00000094 000008A9          A    45    	DL	2217
00000098 0000092D          A    46    	DL	2349
0000009C 000009B9          A    47    	DL	2489
000000A0 00000A4D          A    48    	DL	2637
000000A4 00000AEA          A    49    	DL	2794
000000A8 00000B90          A    50    	DL	2960
000000AC 00000C40          A    51    	DL	3136
000000B0 00000CFA          A    52    	DL	3322
ZiLOG ZNEO Macro Assembler Version 1.10 (07022203)                                               22-Feb-11     23:13:04     page:   2


PC     Object              I  Line    Source speaker.src
000000B4 00000DC0          A    53    	DL	3520
000000B8 00000E91          A    54    	DL	3729
000000BC 00000F6F          A    55    	DL	3951
                           A    56    .define "note_values"
                           A    57    .alias "_note_values"
                           A    58    .class 133
                           A    59    .value _note_values
                           A    60    .dim 4
                           A    61    .dim 12
                           A    62    .type 879
                           A    63    .type 0
                           A    64    .endef
                           A    65    	SEGMENT NEAR_BSS
00000000                   A    66    _duration_timer:
00000000                   A    67    	DS	4*1
                           A    68    .define "duration_timer"
                           A    69    .alias "_duration_timer"
                           A    70    .class 147
                           A    71    .value _duration_timer
                           A    72    .type 5
                           A    73    .type 0
                           A    74    .endef
00000004                   A    75    _duration_cutoff:
00000004                   A    76    	DS	4*1
                           A    77    .define "duration_cutoff"
                           A    78    .alias "_duration_cutoff"
                           A    79    .class 147
                           A    80    .value _duration_cutoff
                           A    81    .type 5
                           A    82    .type 0
                           A    83    .endef
                           A    84    ;    1	#include "speaker.h"
                           A    85    ;    2	#include "timer.h"
                           A    86    ;    3	#include "notes.h"
                           A    87    ;    4	#include "timer.h"
                           A    88    ;    5	#include "rttl.h"
                           A    89    ;    6	#include "oscillator.h"
                           A    90    ;    7	
                           A    91    ;    8	#include <zneo.h>
                           A    92    ;    9	#include <string.h>
                           A    93    ;   10	#include <ctype.h>
                           A    94    ;   11	
                           A    95    ;   12	static int duration_timer;
                           A    96    ;   13	static int duration_cutoff;
                           A    97    	SEGMENT CODE
                           A    98    ;   14	
                           A    99    ;   15	static void play_note(int octave, unsigned char note[3], int duration, int bpm);
                           A   100    ;   16	static void stop_note(void);
                           A   101    ;   17	static void stop_ringtone(void);
                           A   102    ;   18	static void disable_speaker_timer(void);
                           A   103    ;   19	static void init_speaker_timer(void);
                           A   104    ;   20	static void start_speaker_timer(int frequency);
ZiLOG ZNEO Macro Assembler Version 1.10 (07022203)                                               22-Feb-11     23:13:04     page:   3


PC     Object              I  Line    Source speaker.src
                           A   105    ;   21	static int beats_to_duration(int beats, int bpm);
                           A   106    ;   22	
                           A   107    ;   23	/*
                           A   108    ;   24		Initialize the speaker IO ports.
                           A   109    ;   25	
                           A   110    ;   26		Ground:PC0
                           A   111    ;   27		GPIO:PC1 (timer1 output)
                           A   112    ;   28	 */
                           A   113    ;   29	void init_speaker(void)
                           A   114    ;   30	{
00000000                   A   115    _init_speaker:
                           A   116    .define "_init_speaker"
                           A   117    .value _init_speaker
                           A   118    .class 2
                           A   119    .type 65
                           A   120    .type 0
                           A   121    .endef
                           A   122    .begfunc "init_speaker",30,"_init_speaker"
00000000 0800              A   123    	LINK	#0
                           A   124    ;   31		PCDD &= ~0x03;	//set PC0 and PC1 as outputs
                           A   125    .line 31
00000002 30FC              A   126    	LD	R0,#-4
00000004 7250 E122         A   127    	AND.B	57634:RAM,R0
                           A   128    ;   32		PCOUT &= ~0x03; //set PC0 and PC1 low
                           A   129    .line 32
00000008 7250 E121         A   130    	AND.B	57633:RAM,R0
                           A   131    ;   33	
                           A   132    ;   34		duration_timer = 0;
                           A   133    .line 34
0000000C ADA8 0000         A   134    	CLR	_duration_timer:RAM
                           A   135    ;   35		duration_cutoff = 0;
                           A   136    .line 35
00000010 ADA8 0004         A   137    	CLR	_duration_cutoff:RAM
                           A   138    ;   36	
                           A   139    ;   37		init_speaker_timer();
                           A   140    .line 37
00000014 D125              A   141    	CALL	_init_speaker_timer
                           A   142    ;   38	}
                           A   143    .line 38
00000016 0001              A   144    	UNLINK	
00000018 FFFC              A   145    	RET	
                           A   146    
                           A   147    
                           A   148    ;**************************** _init_speaker ***************************
                           A   149    ;Name                         Addr/Register   Size   Type
                           A   150    ;_init_speaker_timer                 STATIC  -----   function
                           A   151    ;_duration_cutoff                    STATIC      4   variable
                           A   152    ;_duration_timer                     STATIC      4   variable
                           A   153    
                           A   154    
                           A   155    ; Aggregate Stack Size: 0 (words)
                           A   156    
ZiLOG ZNEO Macro Assembler Version 1.10 (07022203)                                               22-Feb-11     23:13:04     page:   4


PC     Object              I  Line    Source speaker.src
                           A   157    
                           A   158    .endfunc "init_speaker",38,"_init_speaker"
                           A   159    ;   39	
                           A   160    ;   40	/*
                           A   161    ;   41		Handles all speaker events.
                           A   162    ;   42	 */
                           A   163    ;   43	void speaker_events(void)
                           A   164    ;   44	{
0000001A                   A   165    _speaker_events:
                           A   166    .define "_speaker_events"
                           A   167    .value _speaker_events
                           A   168    .class 2
                           A   169    .type 65
                           A   170    .type 0
                           A   171    .endef
                           A   172    .begfunc "speaker_events",44,"_speaker_events"
0000001A 0800              A   173    	LINK	#0
                           A   174    ;   45		if(duration_cutoff) {
                           A   175    .line 45
0000001C ADA9 0004         A   176    	CPZ	_duration_cutoff:RAM
00000020 E6 0C             A   177    	JP	EQ,_2_L_3
                           A   178    ;   46			duration_timer += timer_interval_int();
                           A   179    .line 46
00000022 F1 FFFFED         A   180    	CALL	_timer_interval_int
00000026 7070 0000         A   181    	ADD	_duration_timer:RAM,R0
                           A   182    ;   47			
                           A   183    ;   48			if(duration_timer >= duration_cutoff) {
                           A   184    .line 48
0000002A 0340 0004         A   185    	LD	R0,_duration_cutoff:RAM
0000002E 7570 0000         A   186    	CP	_duration_timer:RAM,R0
00000032 E1 03             A   187    	JP	LT,_2_L_3
                           A   188    ;   49				disable_speaker_timer();
                           A   189    .line 49
00000034 D004              A   190    	CALL	_disable_speaker_timer
                           A   191    ;   50			
                           A   192    ;   51				play_next_note();
                           A   193    .line 51
00000036 F1 FFFFE3         A   194    	CALL	_play_next_note
                           A   195    ;   52			}
                           A   196    ;   53		}
                           A   197    ;   54	}
0000003A                   A   198    _2_L_3:
                           A   199    .line 54
0000003A 0001              A   200    	UNLINK	
0000003C FFFC              A   201    	RET	
                           A   202    
                           A   203    
                           A   204    ;**************************** _speaker_events ***************************
                           A   205    ;Name                         Addr/Register   Size   Type
                           A   206    ;_play_next_note                     IMPORT  -----   function
                           A   207    ;_disable_speaker_timer              STATIC  -----   function
                           A   208    ;_duration_timer                     STATIC      4   variable
ZiLOG ZNEO Macro Assembler Version 1.10 (07022203)                                               22-Feb-11     23:13:04     page:   5


PC     Object              I  Line    Source speaker.src
                           A   209    ;_timer_interval_int                 IMPORT  -----   function
                           A   210    ;_duration_cutoff                    STATIC      4   variable
                           A   211    
                           A   212    
                           A   213    ; Aggregate Stack Size: 0 (words)
                           A   214    
                           A   215    
                           A   216    .endfunc "speaker_events",54,"_speaker_events"
                           A   217    ;   55	
                           A   218    ;   56	/*
                           A   219    ;   57		Disables timer1 and sets PC1 low.
                           A   220    ;   58	 */
                           A   221    ;   59	void disable_speaker_timer(void)
                           A   222    ;   60	{
0000003E                   A   223    _disable_speaker_timer:
                           A   224    .define "_disable_speaker_timer"
                           A   225    .value _disable_speaker_timer
                           A   226    .class 2
                           A   227    .type 65
                           A   228    .type 0
                           A   229    .endef
                           A   230    .begfunc "disable_speaker_timer",60,"_disable_speaker_timer"
0000003E 0800              A   231    	LINK	#0
                           A   232    ;   61		duration_cutoff = 0;
                           A   233    .line 61
00000040 ADA8 0004         A   234    	CLR	_duration_cutoff:RAM
                           A   235    ;   62		duration_timer = 0;
                           A   236    .line 62
00000044 ADA8 0000         A   237    	CLR	_duration_timer:RAM
                           A   238    ;   63	
                           A   239    ;   64		T1CTL1 |= TIMER_DISABLE;
                           A   240    .line 64
00000048 0310 E317         A   241    	LD.SB	R0,58135:RAM
                           A   242    ;   65		PCOUT &= ~0x02;	//set PC1 low
                           A   243    .line 65
0000004C 30FD              A   244    	LD	R0,#-3
0000004E 7250 E121         A   245    	AND.B	57633:RAM,R0
                           A   246    ;   66		PCAF &= ~0x02;
                           A   247    .line 66
00000052 7260 E124         A   248    	AND.W	57636:RAM,R0
                           A   249    ;   67	}
                           A   250    .line 67
00000056 0001              A   251    	UNLINK	
00000058 FFFC              A   252    	RET	
                           A   253    
                           A   254    
                           A   255    ;**************************** _disable_speaker_timer ***************************
                           A   256    ;Name                         Addr/Register   Size   Type
                           A   257    ;_duration_timer                     STATIC      4   variable
                           A   258    ;_duration_cutoff                    STATIC      4   variable
                           A   259    
                           A   260    
ZiLOG ZNEO Macro Assembler Version 1.10 (07022203)                                               22-Feb-11     23:13:04     page:   6


PC     Object              I  Line    Source speaker.src
                           A   261    ; Aggregate Stack Size: 0 (words)
                           A   262    
                           A   263    
                           A   264    .endfunc "disable_speaker_timer",67,"_disable_speaker_timer"
                           A   265    	SEGMENT ROM_TEXT
00000000                   A   266    L__6:
00000000 61                A   267    	DB	"a"
00000001 00                A   268    	DB	0
00000002                   A   269    L__8:
00000002 6123              A   270    	DB	"a#"
00000004 00                A   271    	DB	0
00000005                   A   272    L__10:
00000005 62                A   273    	DB	"b"
00000006 00                A   274    	DB	0
00000007                   A   275    L__12:
00000007 63                A   276    	DB	"c"
00000008 00                A   277    	DB	0
00000009                   A   278    L__14:
00000009 6323              A   279    	DB	"c#"
0000000B 00                A   280    	DB	0
0000000C                   A   281    L__16:
0000000C 64                A   282    	DB	"d"
0000000D 00                A   283    	DB	0
0000000E                   A   284    L__18:
0000000E 6423              A   285    	DB	"d#"
00000010 00                A   286    	DB	0
00000011                   A   287    L__20:
00000011 65                A   288    	DB	"e"
00000012 00                A   289    	DB	0
00000013                   A   290    L__22:
00000013 66                A   291    	DB	"f"
00000014 00                A   292    	DB	0
00000015                   A   293    L__24:
00000015 6623              A   294    	DB	"f#"
00000017 00                A   295    	DB	0
00000018                   A   296    L__26:
00000018 67                A   297    	DB	"g"
00000019 00                A   298    	DB	0
0000001A                   A   299    L__28:
0000001A 6723              A   300    	DB	"g#"
0000001C 00                A   301    	DB	0
                           A   302    	SEGMENT CODE
                           A   303    ;   68	
                           A   304    ;   69	/*
                           A   305    ;   70		Play a note in a given octave for a given duration on the speaker.
                           A   306    ;   71	 */
                           A   307    ;   72	void play_note(int octave, unsigned char note[3], int duration, int bpm)
                           A   308    ;   73	{
0000005A                   A   309    _play_note:
                           A   310    .define "_play_note"
                           A   311    .value _play_note
                           A   312    .class 2
ZiLOG ZNEO Macro Assembler Version 1.10 (07022203)                                               22-Feb-11     23:13:04     page:   7


PC     Object              I  Line    Source speaker.src
                           A   313    .type 65
                           A   314    .type 0
                           A   315    .endef
                           A   316    .begfunc "play_note",73,"_play_note"
0000005A 080E              A   317    	LINK	#14
                           A   318    .line 73
0000005C 5BC1              A   319    	LD	-4(R14),R1
                           A   320    .define "octave"
                           A   321    .class 9
                           A   322    .value -4
                           A   323    .type 5
                           A   324    .type 0
                           A   325    .endef
0000005E 57A2              A   326    	LD.W	-6(R14),R2
                           A   327    .define "note"
                           A   328    .class 9
                           A   329    .value -6
                           A   330    .type 140
                           A   331    .type 0
                           A   332    .endef
00000060 5B63              A   333    	LD	-10(R14),R3
                           A   334    .define "duration"
                           A   335    .class 9
                           A   336    .value -10
                           A   337    .type 5
                           A   338    .type 0
                           A   339    .endef
00000062 5B24              A   340    	LD	-14(R14),R4
                           A   341    .define "bpm"
                           A   342    .class 9
                           A   343    .value -14
                           A   344    .type 5
                           A   345    .type 0
                           A   346    .endef
                           A   347    ;   74		//if not lowercase, make lowercase
                           A   348    ;   75		if(!islower(note[0])) {
                           A   349    .line 75
00000064 6FA0              A   350    	LD.SW	R0,-6(R14)
00000066 1801              A   351    	LD.UB	R1,(R0)
00000068 F1 FFFFCA         A   352    	CALL	_islower
0000006C 9000              A   353    	CP	R0,#0
0000006E EE 06             A   354    	JP	NE,_4_L_29
                           A   355    ;   76			note[0] = tolower(note[0]);
                           A   356    .line 76
00000070 6FA0              A   357    	LD.SW	R0,-6(R14)
00000072 1801              A   358    	LD.UB	R1,(R0)
00000074 F1 FFFFC4         A   359    	CALL	_tolower
00000078 6FA1              A   360    	LD.SW	R1,-6(R14)
0000007A 0E01              A   361    	LD.B	(R1),R0
                           A   362    ;   77		}
0000007C                   A   363    _4_L_29:
                           A   364    .line 77
ZiLOG ZNEO Macro Assembler Version 1.10 (07022203)                                               22-Feb-11     23:13:04     page:   8


PC     Object              I  Line    Source speaker.src
                           A   365    ;   78	
                           A   366    ;   79		//figure out what note it is
                           A   367    ;   80		if(!strncmp(note, "a", 2)) {
                           A   368    .line 80
0000007C 6FA1              A   369    	LD.SW	R1,-6(R14)
0000007E 4502 0000         A   370    	LD	R2,#L__6
00000082 3302              A   371    	LD	R3,#2
00000084 F1 FFFFBC         A   372    	CALL	_strncmp
00000088 9000              A   373    	CP	R0,#0
0000008A EE 0B             A   374    	JP	NE,_4_L_28
                           A   375    ;   81			start_speaker_timer(note_values[octave - NUM_OCTAVES][NOTE_A]);
                           A   376    .line 81
0000008C 5FC0              A   377    	LD	R0,-4(R14)
0000008E 80FC              A   378    	ADD	R0,#-4
00000090 3130              A   379    	LD	R1,#48
00000092 B110              A   380    	SMUL	R0,R1
00000094 4511 0000         A   381    	LD	R1,#_note_values
00000098 A010              A   382    	ADD	R0,R1
0000009A 4801 0028         A   383    	LD	R1,40(R0)
0000009E D0E8              A   384    	CALL	_start_speaker_timer
                           A   385    ;   82		}
                           A   386    ;   83		else if(!strncmp(note, "a#", 2))
                           A   387    .line 83
000000A0 C0D0              A   388    	JP	_4_L_30
000000A2                   A   389    _4_L_28:
000000A2 6FA1              A   390    	LD.SW	R1,-6(R14)
000000A4 4502 0002         A   391    	LD	R2,#L__8
000000A8 3302              A   392    	LD	R3,#2
000000AA F1 FFFFA9         A   393    	CALL	_strncmp
000000AE 9000              A   394    	CP	R0,#0
000000B0 EE 0B             A   395    	JP	NE,_4_L_26
                           A   396    ;   84		{
                           A   397    ;   85			start_speaker_timer(note_values[octave - NUM_OCTAVES][NOTE_ASHARP]);
                           A   398    .line 85
000000B2 5FC0              A   399    	LD	R0,-4(R14)
000000B4 80FC              A   400    	ADD	R0,#-4
000000B6 3130              A   401    	LD	R1,#48
000000B8 B110              A   402    	SMUL	R0,R1
000000BA 4511 0000         A   403    	LD	R1,#_note_values
000000BE A010              A   404    	ADD	R0,R1
000000C0 4801 002C         A   405    	LD	R1,44(R0)
000000C4 D0D5              A   406    	CALL	_start_speaker_timer
                           A   407    ;   86		}
                           A   408    ;   87		else if(!strncmp(note, "b", 2))
                           A   409    .line 87
000000C6 C0BD              A   410    	JP	_4_L_30
000000C8                   A   411    _4_L_26:
000000C8 6FA1              A   412    	LD.SW	R1,-6(R14)
000000CA 4502 0005         A   413    	LD	R2,#L__10
000000CE 3302              A   414    	LD	R3,#2
000000D0 F1 FFFF96         A   415    	CALL	_strncmp
000000D4 9000              A   416    	CP	R0,#0
ZiLOG ZNEO Macro Assembler Version 1.10 (07022203)                                               22-Feb-11     23:13:04     page:   9


PC     Object              I  Line    Source speaker.src
000000D6 EE 0B             A   417    	JP	NE,_4_L_24
                           A   418    ;   88		{
                           A   419    ;   89			start_speaker_timer(note_values[octave - NUM_OCTAVES][NOTE_B]);
                           A   420    .line 89
000000D8 5FC0              A   421    	LD	R0,-4(R14)
000000DA 80FC              A   422    	ADD	R0,#-4
000000DC 3130              A   423    	LD	R1,#48
000000DE B110              A   424    	SMUL	R0,R1
000000E0 4511 0000         A   425    	LD	R1,#_note_values
000000E4 A010              A   426    	ADD	R0,R1
000000E6 4801 0030         A   427    	LD	R1,48(R0)
000000EA D0C2              A   428    	CALL	_start_speaker_timer
                           A   429    ;   90		}
                           A   430    ;   91		else if(!strncmp(note, "c", 2))
                           A   431    .line 91
000000EC C0AA              A   432    	JP	_4_L_30
000000EE                   A   433    _4_L_24:
000000EE 6FA1              A   434    	LD.SW	R1,-6(R14)
000000F0 4502 0007         A   435    	LD	R2,#L__12
000000F4 3302              A   436    	LD	R3,#2
000000F6 F1 FFFF83         A   437    	CALL	_strncmp
000000FA 9000              A   438    	CP	R0,#0
000000FC EE 0B             A   439    	JP	NE,_4_L_22
                           A   440    ;   92		{
                           A   441    ;   93			start_speaker_timer(note_values[octave - NUM_OCTAVES][NOTE_C]);
                           A   442    .line 93
000000FE 5FC0              A   443    	LD	R0,-4(R14)
00000100 80FC              A   444    	ADD	R0,#-4
00000102 3130              A   445    	LD	R1,#48
00000104 B110              A   446    	SMUL	R0,R1
00000106 4511 0000         A   447    	LD	R1,#_note_values
0000010A A010              A   448    	ADD	R0,R1
0000010C 4801 0004         A   449    	LD	R1,4(R0)
00000110 D0AF              A   450    	CALL	_start_speaker_timer
                           A   451    ;   94		}
                           A   452    ;   95		else if(!strncmp(note, "c#", 2))
                           A   453    .line 95
00000112 C097              A   454    	JP	_4_L_30
00000114                   A   455    _4_L_22:
00000114 6FA1              A   456    	LD.SW	R1,-6(R14)
00000116 4502 0009         A   457    	LD	R2,#L__14
0000011A 3302              A   458    	LD	R3,#2
0000011C F1 FFFF70         A   459    	CALL	_strncmp
00000120 9000              A   460    	CP	R0,#0
00000122 EE 0B             A   461    	JP	NE,_4_L_20
                           A   462    ;   96		{
                           A   463    ;   97			start_speaker_timer(note_values[octave - NUM_OCTAVES][NOTE_CSHARP]);
                           A   464    .line 97
00000124 5FC0              A   465    	LD	R0,-4(R14)
00000126 80FC              A   466    	ADD	R0,#-4
00000128 3130              A   467    	LD	R1,#48
0000012A B110              A   468    	SMUL	R0,R1
ZiLOG ZNEO Macro Assembler Version 1.10 (07022203)                                               22-Feb-11     23:13:04     page:  10


PC     Object              I  Line    Source speaker.src
0000012C 4511 0000         A   469    	LD	R1,#_note_values
00000130 A010              A   470    	ADD	R0,R1
00000132 4801 0008         A   471    	LD	R1,8(R0)
00000136 D09C              A   472    	CALL	_start_speaker_timer
                           A   473    ;   98		}
                           A   474    ;   99		else if(!strncmp(note, "d", 2))
                           A   475    .line 99
00000138 C084              A   476    	JP	_4_L_30
0000013A                   A   477    _4_L_20:
0000013A 6FA1              A   478    	LD.SW	R1,-6(R14)
0000013C 4502 000C         A   479    	LD	R2,#L__16
00000140 3302              A   480    	LD	R3,#2
00000142 F1 FFFF5D         A   481    	CALL	_strncmp
00000146 9000              A   482    	CP	R0,#0
00000148 EE 0B             A   483    	JP	NE,_4_L_18
                           A   484    ;  100		{
                           A   485    ;  101			start_speaker_timer(note_values[octave - NUM_OCTAVES][NOTE_D]);
                           A   486    .line 101
0000014A 5FC0              A   487    	LD	R0,-4(R14)
0000014C 80FC              A   488    	ADD	R0,#-4
0000014E 3130              A   489    	LD	R1,#48
00000150 B110              A   490    	SMUL	R0,R1
00000152 4511 0000         A   491    	LD	R1,#_note_values
00000156 A010              A   492    	ADD	R0,R1
00000158 4801 000C         A   493    	LD	R1,12(R0)
0000015C D089              A   494    	CALL	_start_speaker_timer
                           A   495    ;  102		}
                           A   496    ;  103		else if(!strncmp(note, "d#", 2))
                           A   497    .line 103
0000015E C071              A   498    	JP	_4_L_30
00000160                   A   499    _4_L_18:
00000160 6FA1              A   500    	LD.SW	R1,-6(R14)
00000162 4502 000E         A   501    	LD	R2,#L__18
00000166 3302              A   502    	LD	R3,#2
00000168 F1 FFFF4A         A   503    	CALL	_strncmp
0000016C 9000              A   504    	CP	R0,#0
0000016E EE 0B             A   505    	JP	NE,_4_L_16
                           A   506    ;  104		{
                           A   507    ;  105			start_speaker_timer(note_values[octave - NUM_OCTAVES][NOTE_DSHARP]);
                           A   508    .line 105
00000170 5FC0              A   509    	LD	R0,-4(R14)
00000172 80FC              A   510    	ADD	R0,#-4
00000174 3130              A   511    	LD	R1,#48
00000176 B110              A   512    	SMUL	R0,R1
00000178 4511 0000         A   513    	LD	R1,#_note_values
0000017C A010              A   514    	ADD	R0,R1
0000017E 4801 0010         A   515    	LD	R1,16(R0)
00000182 D076              A   516    	CALL	_start_speaker_timer
                           A   517    ;  106		}
                           A   518    ;  107		else if(!strncmp(note, "e", 2))
                           A   519    .line 107
00000184 C05E              A   520    	JP	_4_L_30
ZiLOG ZNEO Macro Assembler Version 1.10 (07022203)                                               22-Feb-11     23:13:04     page:  11


PC     Object              I  Line    Source speaker.src
00000186                   A   521    _4_L_16:
00000186 6FA1              A   522    	LD.SW	R1,-6(R14)
00000188 4502 0011         A   523    	LD	R2,#L__20
0000018C 3302              A   524    	LD	R3,#2
0000018E F1 FFFF37         A   525    	CALL	_strncmp
00000192 9000              A   526    	CP	R0,#0
00000194 EE 0B             A   527    	JP	NE,_4_L_14
                           A   528    ;  108		{
                           A   529    ;  109			start_speaker_timer(note_values[octave - NUM_OCTAVES][NOTE_E]);
                           A   530    .line 109
00000196 5FC0              A   531    	LD	R0,-4(R14)
00000198 80FC              A   532    	ADD	R0,#-4
0000019A 3130              A   533    	LD	R1,#48
0000019C B110              A   534    	SMUL	R0,R1
0000019E 4511 0000         A   535    	LD	R1,#_note_values
000001A2 A010              A   536    	ADD	R0,R1
000001A4 4801 0014         A   537    	LD	R1,20(R0)
000001A8 D063              A   538    	CALL	_start_speaker_timer
                           A   539    ;  110		}
                           A   540    ;  111		else if(!strncmp(note, "f", 2))
                           A   541    .line 111
000001AA C04B              A   542    	JP	_4_L_30
000001AC                   A   543    _4_L_14:
000001AC 6FA1              A   544    	LD.SW	R1,-6(R14)
000001AE 4502 0013         A   545    	LD	R2,#L__22
000001B2 3302              A   546    	LD	R3,#2
000001B4 F1 FFFF24         A   547    	CALL	_strncmp
000001B8 9000              A   548    	CP	R0,#0
000001BA EE 0B             A   549    	JP	NE,_4_L_12
                           A   550    ;  112		{
                           A   551    ;  113			start_speaker_timer(note_values[octave - NUM_OCTAVES][NOTE_F]);
                           A   552    .line 113
000001BC 5FC0              A   553    	LD	R0,-4(R14)
000001BE 80FC              A   554    	ADD	R0,#-4
000001C0 3130              A   555    	LD	R1,#48
000001C2 B110              A   556    	SMUL	R0,R1
000001C4 4511 0000         A   557    	LD	R1,#_note_values
000001C8 A010              A   558    	ADD	R0,R1
000001CA 4801 0018         A   559    	LD	R1,24(R0)
000001CE D050              A   560    	CALL	_start_speaker_timer
                           A   561    ;  114		}
                           A   562    ;  115		else if(!strncmp(note, "f#", 2))
                           A   563    .line 115
000001D0 C038              A   564    	JP	_4_L_30
000001D2                   A   565    _4_L_12:
000001D2 6FA1              A   566    	LD.SW	R1,-6(R14)
000001D4 4502 0015         A   567    	LD	R2,#L__24
000001D8 3302              A   568    	LD	R3,#2
000001DA F1 FFFF11         A   569    	CALL	_strncmp
000001DE 9000              A   570    	CP	R0,#0
000001E0 EE 0B             A   571    	JP	NE,_4_L_10
                           A   572    ;  116		{
ZiLOG ZNEO Macro Assembler Version 1.10 (07022203)                                               22-Feb-11     23:13:04     page:  12


PC     Object              I  Line    Source speaker.src
                           A   573    ;  117			start_speaker_timer(note_values[octave - NUM_OCTAVES][NOTE_FSHARP]);
                           A   574    .line 117
000001E2 5FC0              A   575    	LD	R0,-4(R14)
000001E4 80FC              A   576    	ADD	R0,#-4
000001E6 3130              A   577    	LD	R1,#48
000001E8 B110              A   578    	SMUL	R0,R1
000001EA 4511 0000         A   579    	LD	R1,#_note_values
000001EE A010              A   580    	ADD	R0,R1
000001F0 4801 001C         A   581    	LD	R1,28(R0)
000001F4 D03D              A   582    	CALL	_start_speaker_timer
                           A   583    ;  118		}
                           A   584    ;  119		else if(!strncmp(note, "g", 2))
                           A   585    .line 119
000001F6 C025              A   586    	JP	_4_L_30
000001F8                   A   587    _4_L_10:
000001F8 6FA1              A   588    	LD.SW	R1,-6(R14)
000001FA 4502 0018         A   589    	LD	R2,#L__26
000001FE 3302              A   590    	LD	R3,#2
00000200 F1 FFFEFE         A   591    	CALL	_strncmp
00000204 9000              A   592    	CP	R0,#0
00000206 EE 0B             A   593    	JP	NE,_4_L_8
                           A   594    ;  120		{
                           A   595    ;  121			start_speaker_timer(note_values[octave - NUM_OCTAVES][NOTE_G]);
                           A   596    .line 121
00000208 5FC0              A   597    	LD	R0,-4(R14)
0000020A 80FC              A   598    	ADD	R0,#-4
0000020C 3130              A   599    	LD	R1,#48
0000020E B110              A   600    	SMUL	R0,R1
00000210 4511 0000         A   601    	LD	R1,#_note_values
00000214 A010              A   602    	ADD	R0,R1
00000216 4801 0020         A   603    	LD	R1,32(R0)
0000021A D02A              A   604    	CALL	_start_speaker_timer
                           A   605    ;  122		}
                           A   606    ;  123		else if(!strncmp(note, "g#", 2))
                           A   607    .line 123
0000021C C012              A   608    	JP	_4_L_30
0000021E                   A   609    _4_L_8:
0000021E 6FA1              A   610    	LD.SW	R1,-6(R14)
00000220 4502 001A         A   611    	LD	R2,#L__28
00000224 3302              A   612    	LD	R3,#2
00000226 F1 FFFEEB         A   613    	CALL	_strncmp
0000022A 9000              A   614    	CP	R0,#0
0000022C EE 0A             A   615    	JP	NE,_4_L_30
                           A   616    ;  124		{
                           A   617    ;  125			start_speaker_timer(note_values[octave - NUM_OCTAVES][NOTE_GSHARP]);
                           A   618    .line 125
0000022E 5FC0              A   619    	LD	R0,-4(R14)
00000230 80FC              A   620    	ADD	R0,#-4
00000232 3130              A   621    	LD	R1,#48
00000234 B110              A   622    	SMUL	R0,R1
00000236 4511 0000         A   623    	LD	R1,#_note_values
0000023A A010              A   624    	ADD	R0,R1
ZiLOG ZNEO Macro Assembler Version 1.10 (07022203)                                               22-Feb-11     23:13:04     page:  13


PC     Object              I  Line    Source speaker.src
0000023C 4801 0024         A   625    	LD	R1,36(R0)
00000240 D017              A   626    	CALL	_start_speaker_timer
                           A   627    ;  126		}
00000242                   A   628    _4_L_30:
                           A   629    .line 126
                           A   630    ;  127	
                           A   631    ;  128		//set timer for duration of note
                           A   632    ;  129		duration_timer = 0;
                           A   633    .line 129
00000242 ADA8 0000         A   634    	CLR	_duration_timer:RAM
                           A   635    ;  130		duration_cutoff = beats_to_duration(duration, bpm);
                           A   636    .line 130
00000246 5F61              A   637    	LD	R1,-10(R14)
00000248 5F22              A   638    	LD	R2,-14(R14)
0000024A D03B              A   639    	CALL	_beats_to_duration
0000024C 0370 0004         A   640    	LD	_duration_cutoff:RAM,R0
                           A   641    ;  131	}
                           A   642    .line 131
00000250 0001              A   643    	UNLINK	
00000252 FFFC              A   644    	RET	
                           A   645    
                           A   646    
                           A   647    ;**************************** _play_note ***************************
                           A   648    ;Name                         Addr/Register   Size   Type
                           A   649    ;_duration_cutoff                    STATIC      4   variable
                           A   650    ;_beats_to_duration                  STATIC  -----   function
                           A   651    ;_duration_timer                     STATIC      4   variable
                           A   652    ;_note_values                        STATIC    192   variable
                           A   653    ;_start_speaker_timer                STATIC  -----   function
                           A   654    ;_strncmp                            IMPORT  -----   function
                           A   655    ;_tolower                            IMPORT  -----   function
                           A   656    ;_islower                            IMPORT  -----   function
                           A   657    ;bpm                                 R14-14      4   parameter
                           A   658    ;duration                            R14-10      4   parameter
                           A   659    ;note                                 R14-6      2   parameter
                           A   660    ;octave                               R14-4      4   parameter
                           A   661    
                           A   662    
                           A   663    ; Aggregate Stack Size: -14 (words)
                           A   664    
                           A   665    
                           A   666    .endfunc "play_note",131,"_play_note"
                           A   667    ;  132	
                           A   668    ;  133	/*
                           A   669    ;  134		Play a specific frequency note.
                           A   670    ;  135	
                           A   671    ;  136		This function can be used for testing speakers.
                           A   672    ;  137	 */
                           A   673    ;  138	void play_frequency(int frequency)
                           A   674    ;  139	{
00000254                   A   675    _play_frequency:
                           A   676    .define "_play_frequency"
ZiLOG ZNEO Macro Assembler Version 1.10 (07022203)                                               22-Feb-11     23:13:04     page:  14


PC     Object              I  Line    Source speaker.src
                           A   677    .value _play_frequency
                           A   678    .class 2
                           A   679    .type 65
                           A   680    .type 0
                           A   681    .endef
                           A   682    .begfunc "play_frequency",139,"_play_frequency"
00000254 0804              A   683    	LINK	#4
                           A   684    .line 139
00000256 5BC1              A   685    	LD	-4(R14),R1
                           A   686    .define "frequency"
                           A   687    .class 9
                           A   688    .value -4
                           A   689    .type 5
                           A   690    .type 0
                           A   691    .endef
                           A   692    ;  140		start_speaker_timer(frequency);
                           A   693    .line 140
00000258 5FC1              A   694    	LD	R1,-4(R14)
0000025A D00A              A   695    	CALL	_start_speaker_timer
                           A   696    ;  141	}
                           A   697    .line 141
0000025C 0001              A   698    	UNLINK	
0000025E FFFC              A   699    	RET	
                           A   700    
                           A   701    
                           A   702    ;**************************** _play_frequency ***************************
                           A   703    ;Name                         Addr/Register   Size   Type
                           A   704    ;_start_speaker_timer                STATIC  -----   function
                           A   705    ;frequency                            R14-4      4   parameter
                           A   706    
                           A   707    
                           A   708    ; Aggregate Stack Size: -4 (words)
                           A   709    
                           A   710    
                           A   711    .endfunc "play_frequency",141,"_play_frequency"
                           A   712    ;  142	
                           A   713    ;  143	/*
                           A   714    ;  144		Setup timer1.
                           A   715    ;  145	 */
                           A   716    ;  146	static void init_speaker_timer(void)
                           A   717    ;  147	{
00000260                   A   718    _init_speaker_timer:
                           A   719    .define "_init_speaker_timer"
                           A   720    .value _init_speaker_timer
                           A   721    .class 3
                           A   722    .type 65
                           A   723    .type 0
                           A   724    .endef
                           A   725    .begfunc "init_speaker_timer",147,"_init_speaker_timer"
00000260 0800              A   726    	LINK	#0
                           A   727    ;  148		T1CTL1 |= TIMER_DISABLE;
                           A   728    .line 148
ZiLOG ZNEO Macro Assembler Version 1.10 (07022203)                                               22-Feb-11     23:13:04     page:  15


PC     Object              I  Line    Source speaker.src
00000262 0310 E317         A   729    	LD.SB	R0,58135:RAM
                           A   730    ;  149	
                           A   731    ;  150	    T1CTL1 = TIMER_MODE_CONTINUOUS + TIMER_PRESCALE_64;
                           A   732    .line 150
00000266 3031              A   733    	LD	R0,#49
00000268 0350 E317         A   734    	LD.B	58135:RAM,R0
                           A   735    ;  151	}
                           A   736    .line 151
0000026C 0001              A   737    	UNLINK	
0000026E FFFC              A   738    	RET	
                           A   739    
                           A   740    
                           A   741    ;**************************** _init_speaker_timer ***************************
                           A   742    ;Name                         Addr/Register   Size   Type
                           A   743    
                           A   744    
                           A   745    ; Aggregate Stack Size: 0 (words)
                           A   746    
                           A   747    
                           A   748    .endfunc "init_speaker_timer",151,"_init_speaker_timer"
                           A   749    ;  152	
                           A   750    ;  153	/*
                           A   751    ;  154	 	Enable timer 1. The timer will go off every
                           A   752    ;  155		1 / (2 * frequency) seconds.
                           A   753    ;  156	 */
                           A   754    ;  157	static void start_speaker_timer(int frequency)
                           A   755    ;  158	{
00000270                   A   756    _start_speaker_timer:
                           A   757    .define "_start_speaker_timer"
                           A   758    .value _start_speaker_timer
                           A   759    .class 3
                           A   760    .type 65
                           A   761    .type 0
                           A   762    .endef
                           A   763    .begfunc "start_speaker_timer",158,"_start_speaker_timer"
00000270 0808              A   764    	LINK	#8
00000272 05C0              A   765    	PUSHMHI	#3
                           A   766    .line 158
00000274 5BC1              A   767    	LD	-4(R14),R1
                           A   768    .define "frequency"
                           A   769    .class 9
                           A   770    .value -4
                           A   771    .type 5
                           A   772    .type 0
                           A   773    .endef
                           A   774    .define "timeout"
                           A   775    .class 1
                           A   776    .value -8
                           A   777    .type 6
                           A   778    .type 0
                           A   779    .endef
                           A   780    ;  159		float timeout;
ZiLOG ZNEO Macro Assembler Version 1.10 (07022203)                                               22-Feb-11     23:13:04     page:  16


PC     Object              I  Line    Source speaker.src
                           A   781    ;  160	
                           A   782    ;  161		//calculate the timeout
                           A   783    ;  162		timeout = 1.0f / (float)frequency;
                           A   784    .line 162
00000276 5FC8              A   785    	LD	R8,-4(R14)
00000278 F1 FFFEC2         A   786    	CALL	__fpltof
0000027C 4409              A   787    	LD	R9,R0
0000027E 4528 3F800000     A   788    	LD	R8,#1065353216
00000284 F1 FFFEBC         A   789    	CALL	__fpdiv
00000288 5B80              A   790    	LD	-8(R14),R0
                           A   791    ;  163	
                           A   792    ;  164		// Initial counter value
                           A   793    ;  165	    T1HL = 0x00;
                           A   794    .line 165
0000028A ADA4 E310         A   795    	CLR.W	58128:RAM
                           A   796    ;  166	
                           A   797    ;  167		// Timer reload
                           A   798    ;  168	    //   reload = clock / prescale * timeout  
                           A   799    ;  169	    T1R = get_osc_clock() / 64 * timeout;
                           A   800    .line 169
0000028E F1 FFFEB7         A   801    	CALL	_get_osc_clock
00000292 3140              A   802    	LD	R1,#64
00000294 AF10              A   803    	SDIV	R0,R1
00000296 4408              A   804    	LD	R8,R0
00000298 F1 FFFEB2         A   805    	CALL	__fpltof
0000029C 4408              A   806    	LD	R8,R0
0000029E 5F89              A   807    	LD	R9,-8(R14)
000002A0 F1 FFFEAE         A   808    	CALL	__fpmul
000002A4 4408              A   809    	LD	R8,R0
000002A6 F1 FFFEAB         A   810    	CALL	__fpftol
000002AA 0360 E312         A   811    	LD.W	58130:RAM,R0
                           A   812    ;  170	
                           A   813    ;  171		// Enable Timer0 interrupt
                           A   814    ;  172	    //IRQ1EN = IRQ_Timer1;
                           A   815    ;  173	
                           A   816    ;  174		T1CTL1 |= TIMER_ENABLE;
                           A   817    .line 174
000002AE 4500 0080         A   818    	LD	R0,#128
000002B2 7350 E317         A   819    	OR.B	58135:RAM,R0
                           A   820    ;  175	
                           A   821    ;  176		//set PC1 as T1OUT
                           A   822    ;  177		PCAF |= 0x02;
                           A   823    .line 177
000002B6 3002              A   824    	LD	R0,#2
000002B8 7360 E124         A   825    	OR.W	57636:RAM,R0
                           A   826    ;  178	}
                           A   827    .line 178
000002BC 0703              A   828    	POPMHI	#3
000002BE 0001              A   829    	UNLINK	
000002C0 FFFC              A   830    	RET	
                           A   831    
                           A   832    
ZiLOG ZNEO Macro Assembler Version 1.10 (07022203)                                               22-Feb-11     23:13:04     page:  17


PC     Object              I  Line    Source speaker.src
                           A   833    ;**************************** _start_speaker_timer ***************************
                           A   834    ;Name                         Addr/Register   Size   Type
                           A   835    ;_get_osc_clock                      IMPORT  -----   function
                           A   836    ;timeout                              R14-8      4   variable
                           A   837    ;frequency                            R14-4      4   parameter
                           A   838    
                           A   839    
                           A   840    ; Aggregate Stack Size: -8 (words)
                           A   841    
                           A   842    
                           A   843    .endfunc "start_speaker_timer",178,"_start_speaker_timer"
                           A   844    ;  179	
                           A   845    ;  180	/*
                           A   846    ;  181		Convert a duration to a time value using beats per minute.
                           A   847    ;  182	 */
                           A   848    ;  183	static int beats_to_duration(int beats, int bpm)
                           A   849    ;  184	{
000002C2                   A   850    _beats_to_duration:
                           A   851    .define "_beats_to_duration"
                           A   852    .value _beats_to_duration
                           A   853    .class 3
                           A   854    .type 69
                           A   855    .type 0
                           A   856    .endef
                           A   857    .begfunc "beats_to_duration",184,"_beats_to_duration"
                           A   858    .line 184
                           A   859    .define "beats"
                           A   860    .class 17
                           A   861    .reg 2
                           A   862    .type 5
                           A   863    .type 0
                           A   864    .endef
                           A   865    .define "bpm"
                           A   866    .class 17
                           A   867    .reg 3
                           A   868    .type 5
                           A   869    .type 0
                           A   870    .endef
000002C2 0800              A   871    	LINK	#0
000002C4 05C0              A   872    	PUSHMHI	#3
                           A   873    ;  185		return (int)((60.0f / (float)bpm) * (4.0f / (float)beats) * 1000.0f);
                           A   874    .line 185
000002C6 4428              A   875    	LD	R8,R2
000002C8 F1 FFFE9A         A   876    	CALL	__fpltof
000002CC 4409              A   877    	LD	R9,R0
000002CE 4528 42700000     A   878    	LD	R8,#1114636288
000002D4 F1 FFFE94         A   879    	CALL	__fpdiv
000002D8 4402              A   880    	LD	R2,R0
000002DA 4418              A   881    	LD	R8,R1
000002DC F1 FFFE90         A   882    	CALL	__fpltof
000002E0 4409              A   883    	LD	R9,R0
000002E2 4528 40800000     A   884    	LD	R8,#1082130432
ZiLOG ZNEO Macro Assembler Version 1.10 (07022203)                                               22-Feb-11     23:13:04     page:  18


PC     Object              I  Line    Source speaker.src
000002E8 F1 FFFE8A         A   885    	CALL	__fpdiv
000002EC 4428              A   886    	LD	R8,R2
000002EE 4409              A   887    	LD	R9,R0
000002F0 F1 FFFE86         A   888    	CALL	__fpmul
000002F4 4408              A   889    	LD	R8,R0
000002F6 4529 447A0000     A   890    	LD	R9,#1148846080
000002FC F1 FFFE80         A   891    	CALL	__fpmul
00000300 4408              A   892    	LD	R8,R0
00000302 F1 FFFE7D         A   893    	CALL	__fpftol
                           A   894    ;  186	}
                           A   895    .line 186
00000306 0703              A   896    	POPMHI	#3
00000308 0001              A   897    	UNLINK	
0000030A FFFC              A   898    	RET	
                           A   899    
                           A   900    
                           A   901    ;**************************** _beats_to_duration ***************************
                           A   902    ;Name                         Addr/Register   Size   Type
                           A   903    ;bpm                                     R2      4   parameter
                           A   904    ;beats                                   R1      4   parameter
                           A   905    
                           A   906    
                           A   907    ; Aggregate Stack Size: 0 (words)
                           A   908    
                           A   909    
                           A   910    .endfunc "beats_to_duration",186,"_beats_to_duration"
                           A   911    	XREF _tolower:EROM
                           A   912    	XREF _islower:EROM
                           A   913    	XREF _strncmp:EROM
                           A   914    	XREF _get_osc_clock:EROM
                           A   915    	XREF _play_next_note:EROM
                           A   916    	XREF _timer_interval_int:EROM
                           A   917    	XREF __fpltof:EROM
                           A   918    	XREF __fpftol:EROM
                           A   919    	XREF __fpdiv:EROM
                           A   920    	XREF __fpmul:EROM
                           A   921    	XDEF _play_frequency
                           A   922    	XDEF _play_note
                           A   923    	XDEF _disable_speaker_timer
                           A   924    	XDEF _speaker_events
                           A   925    	XDEF _init_speaker
                           A   926    	XDEF _note_values
                           A   927    	END


Errors: 0
Warnings: 0
Lines Assembled: 928
