ZiLOG ZNEO Macro Assembler Version 1.10 (07022203)                                               27-Feb-11     17:33:57     page:   1


PC     Object              I  Line    Source 
                           A     1    ; ZiLOG ZNEO ANSI C Compiler Release 1.11
                           A     2    ; -nolocalcse -optsize -model=S -nomodsect -noregvar
                           A     3    ; -reduceopt -debug -peephole -const=ROM -alias -fastcall
                           A     4    	FILE	"..\BUTTONS.C"
                           A     5    .debug "C"
                           A     6    	SEGMENT NEAR_BSS
00000000                   A     7    _button_timer:
00000000                   A     8    	DS	4*1
                           A     9    .define "button_timer"
                           A    10    .alias "_button_timer"
                           A    11    .class 147
                           A    12    .value _button_timer
                           A    13    .type 5
                           A    14    .type 0
                           A    15    .endef
00000004                   A    16    _debounce_cutoff:
00000004                   A    17    	DS	4*1
                           A    18    .define "debounce_cutoff"
                           A    19    .alias "_debounce_cutoff"
                           A    20    .class 147
                           A    21    .value _debounce_cutoff
                           A    22    .type 5
                           A    23    .type 0
                           A    24    .endef
00000008                   A    25    _button_twice_timer:
00000008                   A    26    	DS	4*1
                           A    27    .define "button_twice_timer"
                           A    28    .alias "_button_twice_timer"
                           A    29    .class 147
                           A    30    .value _button_twice_timer
                           A    31    .type 5
                           A    32    .type 0
                           A    33    .endef
0000000C                   A    34    _button_twice_cutoff:
0000000C                   A    35    	DS	4*1
                           A    36    .define "button_twice_cutoff"
                           A    37    .alias "_button_twice_cutoff"
                           A    38    .class 147
                           A    39    .value _button_twice_cutoff
                           A    40    .type 5
                           A    41    .type 0
                           A    42    .endef
00000010                   A    43    _last_button:
00000010                   A    44    	DS	1
                           A    45    .define "last_button"
                           A    46    .alias "_last_button"
                           A    47    .class 147
                           A    48    .value _last_button
                           A    49    .type 12
                           A    50    .type 0
                           A    51    .endef
00000011                   A    52    _current:
ZiLOG ZNEO Macro Assembler Version 1.10 (07022203)                                               27-Feb-11     17:33:57     page:   2


PC     Object              I  Line    Source buttons.src
00000011                   A    53    	DS	1
                           A    54    .define "current"
                           A    55    .alias "_current"
                           A    56    .class 147
                           A    57    .value _current
                           A    58    .type 12
                           A    59    .type 0
                           A    60    .endef
00000012                   A    61    _previous:
00000012                   A    62    	DS	1
                           A    63    .define "previous"
                           A    64    .alias "_previous"
                           A    65    .class 147
                           A    66    .value _previous
                           A    67    .type 12
                           A    68    .type 0
                           A    69    .endef
00000013                   A    70    _button_state:
00000013                   A    71    	DS	2*1
                           A    72    .define "button_state"
                           A    73    .alias "_button_state"
                           A    74    .class 147
                           A    75    .value _button_state
                           A    76    .type 13
                           A    77    .type 0
                           A    78    .endef
                           A    79    ;    1	#include "buttons.h"
                           A    80    ;    2	#include "timer.h"
                           A    81    ;    3	
                           A    82    ;    4	#include <zneo.h>
                           A    83    ;    5	
                           A    84    ;    6	#define DEBOUNCE_CUTOFF     40 	//40 ms
                           A    85    ;    7	#define BUTTON_TWICE_CUTOFF 500	//500 ms
                           A    86    ;    8	
                           A    87    ;    9	#define BUTTON_NONE  0xC8
                           A    88    ;   10	#define BUTTON_ONE   0xC0
                           A    89    ;   11	#define BUTTON_TWO   0x88
                           A    90    ;   12	#define BUTTON_THREE 0x48
                           A    91    ;   13	
                           A    92    ;   14	#define BUTTON_PRESSED     1
                           A    93    ;   15	#define BUTTON_NOT_PRESSED 0
                           A    94    ;   16	
                           A    95    ;   17	static volatile int button_timer;
                           A    96    ;   18	static int debounce_cutoff;
                           A    97    ;   19	static volatile int button_twice_timer;
                           A    98    ;   20	static int button_twice_cutoff;
                           A    99    ;   21	
                           A   100    ;   22	static volatile unsigned char last_button;
                           A   101    ;   23	static volatile unsigned char current;
                           A   102    ;   24	static volatile unsigned char previous;
                           A   103    ;   25	static volatile unsigned short button_state;
                           A   104    	SEGMENT CODE
ZiLOG ZNEO Macro Assembler Version 1.10 (07022203)                                               27-Feb-11     17:33:57     page:   3


PC     Object              I  Line    Source buttons.src
                           A   105    ;   26	
                           A   106    ;   27	static void handle_button_events(void);
                           A   107    ;   28	
                           A   108    ;   29	/*
                           A   109    ;   30		Initializes the buttons.
                           A   110    ;   31	 */
                           A   111    ;   32	void init_buttons(void)
                           A   112    ;   33	{
00000000                   A   113    _init_buttons:
                           A   114    .define "_init_buttons"
                           A   115    .value _init_buttons
                           A   116    .class 2
                           A   117    .type 65
                           A   118    .type 0
                           A   119    .endef
                           A   120    .begfunc "init_buttons",33,"_init_buttons"
00000000 0800              A   121    	LINK	#0
                           A   122    ;   34		//set as inputs
                           A   123    ;   35		PDDD |= BUTTON_ONE;
                           A   124    .line 35
00000002 4500 00C0         A   125    	LD	R0,#192
00000006 7350 E132         A   126    	OR.B	57650:RAM,R0
                           A   127    ;   36		PFDD |= BUTTON_TWO + BUTTON_THREE;
                           A   128    .line 36
0000000A 4500 00D0         A   129    	LD	R0,#208
0000000E 7350 E152         A   130    	OR.B	57682:RAM,R0
                           A   131    ;   37	
                           A   132    ;   38		current = BUTTON_NONE;
                           A   133    .line 38
00000012 4500 00C8         A   134    	LD	R0,#200
00000016 0350 0011         A   135    	LD.B	_current:RAM,R0
                           A   136    ;   39		previous = BUTTON_NONE;
                           A   137    .line 39
0000001A 0350 0012         A   138    	LD.B	_previous:RAM,R0
                           A   139    ;   40		button_state = BUTTON_NOT_PRESSED;
                           A   140    .line 40
0000001E ADA4 0013         A   141    	CLR.W	_button_state:RAM
                           A   142    ;   41		last_button = BUTTON_NONE;
                           A   143    .line 41
00000022 0350 0010         A   144    	LD.B	_last_button:RAM,R0
                           A   145    ;   42	
                           A   146    ;   43		button_timer = 0;
                           A   147    .line 43
00000026 ADA8 0000         A   148    	CLR	_button_timer:RAM
                           A   149    ;   44		debounce_cutoff = DEBOUNCE_CUTOFF;
                           A   150    .line 44
0000002A 3028              A   151    	LD	R0,#40
0000002C 0370 0004         A   152    	LD	_debounce_cutoff:RAM,R0
                           A   153    ;   45	
                           A   154    ;   46		button_twice_timer = 0;
                           A   155    .line 46
00000030 ADA8 0008         A   156    	CLR	_button_twice_timer:RAM
ZiLOG ZNEO Macro Assembler Version 1.10 (07022203)                                               27-Feb-11     17:33:57     page:   4


PC     Object              I  Line    Source buttons.src
                           A   157    ;   47		button_twice_cutoff = BUTTON_TWICE_CUTOFF;
                           A   158    .line 47
00000034 4500 01F4         A   159    	LD	R0,#500
00000038 0370 000C         A   160    	LD	_button_twice_cutoff:RAM,R0
                           A   161    ;   48	}
                           A   162    .line 48
0000003C 0001              A   163    	UNLINK	
0000003E FFFC              A   164    	RET	
                           A   165    
                           A   166    
                           A   167    ;**************************** _init_buttons ***************************
                           A   168    ;Name                         Addr/Register   Size   Type
                           A   169    ;_button_twice_cutoff                STATIC      4   variable
                           A   170    ;_button_twice_timer                 STATIC      4   variable
                           A   171    ;_debounce_cutoff                    STATIC      4   variable
                           A   172    ;_button_timer                       STATIC      4   variable
                           A   173    ;_last_button                        STATIC      1   variable
                           A   174    ;_button_state                       STATIC      2   variable
                           A   175    ;_previous                           STATIC      1   variable
                           A   176    ;_current                            STATIC      1   variable
                           A   177    
                           A   178    
                           A   179    ; Aggregate Stack Size: 0 (words)
                           A   180    
                           A   181    
                           A   182    .endfunc "init_buttons",48,"_init_buttons"
                           A   183    ;   49	
                           A   184    ;   50	/*
                           A   185    ;   51		Processes button events.
                           A   186    ;   52	 */
                           A   187    ;   53	void button_events(void)
                           A   188    ;   54	{
00000040                   A   189    _button_events:
                           A   190    .define "_button_events"
                           A   191    .value _button_events
                           A   192    .class 2
                           A   193    .type 65
                           A   194    .type 0
                           A   195    .endef
                           A   196    .begfunc "button_events",54,"_button_events"
00000040 0800              A   197    	LINK	#0
                           A   198    ;   55		button_timer += timer_interval_int();
                           A   199    .line 55
00000042 F1 FFFFDD         A   200    	CALL	_timer_interval_int
00000046 7070 0000         A   201    	ADD	_button_timer:RAM,R0
                           A   202    ;   56	
                           A   203    ;   57		if(button_twice_timer >= button_twice_cutoff) {
                           A   204    .line 57
0000004A 0340 000C         A   205    	LD	R0,_button_twice_cutoff:RAM
0000004E 7570 0008         A   206    	CP	_button_twice_timer:RAM,R0
00000052 E1 07             A   207    	JP	LT,_2_L_3
                           A   208    ;   58			button_twice_timer = 0;
ZiLOG ZNEO Macro Assembler Version 1.10 (07022203)                                               27-Feb-11     17:33:57     page:   5


PC     Object              I  Line    Source buttons.src
                           A   209    .line 58
00000054 ADA8 0008         A   210    	CLR	_button_twice_timer:RAM
                           A   211    ;   59			last_button = BUTTON_NONE;
                           A   212    .line 59
00000058 4500 00C8         A   213    	LD	R0,#200
0000005C 0350 0010         A   214    	LD.B	_last_button:RAM,R0
                           A   215    ;   60		}
                           A   216    ;   61		else if(button_twice_timer > 0) {
                           A   217    .line 61
00000060 C007              A   218    	JP	_2_L_10
00000062                   A   219    _2_L_3:
00000062 ADA9 0008         A   220    	CPZ	_button_twice_timer:RAM
00000066 E2 04             A   221    	JP	LE,_2_L_10
                           A   222    ;   62			button_twice_timer += timer_interval_int();
                           A   223    .line 62
00000068 F1 FFFFCA         A   224    	CALL	_timer_interval_int
0000006C 7070 0008         A   225    	ADD	_button_twice_timer:RAM,R0
                           A   226    ;   63		}
00000070                   A   227    _2_L_10:
                           A   228    .line 63
                           A   229    ;   64	
                           A   230    ;   65		//check buttons every debounce interval
                           A   231    ;   66		if(button_timer >= debounce_cutoff) {
                           A   232    .line 66
00000070 0340 0004         A   233    	LD	R0,_debounce_cutoff:RAM
00000074 7570 0000         A   234    	CP	_button_timer:RAM,R0
00000078 E1 2E             A   235    	JP	LT,_2_L_11
                           A   236    ;   67			button_timer = 0;
                           A   237    .line 67
0000007A ADA8 0000         A   238    	CLR	_button_timer:RAM
                           A   239    ;   68			
                           A   240    ;   69			previous = current;
                           A   241    .line 69
0000007E 0310 0011         A   242    	LD.SB	R0,_current:RAM
00000082 0350 0012         A   243    	LD.B	_previous:RAM,R0
                           A   244    ;   70			current = (PDIN & 0x08) | (PFIN & 0xC0);	//gets the state of all buttons
                           A   245    .line 70
00000086 0311 E150         A   246    	LD.SB	R1,57680:RAM
0000008A AA21 00C0         A   247    	AND	R1,#192
0000008E 0310 E130         A   248    	LD.SB	R0,57648:RAM
00000092 AA20 0008         A   249    	AND	R0,#8
00000096 4402              A   250    	LD	R2,R0
00000098 A310              A   251    	OR	R0,R1
0000009A 0350 0011         A   252    	LD.B	_current:RAM,R0
                           A   253    ;   71			
                           A   254    ;   72			if(current == previous) {
                           A   255    .line 72
0000009E 0310 0012         A   256    	LD.SB	R0,_previous:RAM
000000A2 7550 0011         A   257    	CP.B	_current:RAM,R0
000000A6 EE 17             A   258    	JP	NE,_2_L_11
                           A   259    ;   73				if(current != BUTTON_NONE) {
                           A   260    .line 73
ZiLOG ZNEO Macro Assembler Version 1.10 (07022203)                                               27-Feb-11     17:33:57     page:   6


PC     Object              I  Line    Source buttons.src
000000A8 4500 00C8         A   261    	LD	R0,#200
000000AC 7550 0011         A   262    	CP.B	_current:RAM,R0
000000B0 E6 08             A   263    	JP	EQ,_2_L_7
                           A   264    ;   74					if(button_state == BUTTON_NOT_PRESSED) {
                           A   265    .line 74
000000B2 ADA5 0013         A   266    	CPZ.W	_button_state:RAM
000000B6 EE 0F             A   267    	JP	NE,_2_L_11
                           A   268    ;   75						button_state = BUTTON_PRESSED;
                           A   269    .line 75
000000B8 3001              A   270    	LD	R0,#1
000000BA 0360 0013         A   271    	LD.W	_button_state:RAM,R0
                           A   272    ;   76						handle_button_events();
                           A   273    .line 76
000000BE D00D              A   274    	CALL	_handle_button_events
                           A   275    ;   77					}
                           A   276    ;   78				}
                           A   277    ;   79				else if(button_state == BUTTON_PRESSED) {
                           A   278    .line 79
000000C0 C00A              A   279    	JP	_2_L_11
000000C2                   A   280    _2_L_7:
000000C2 3001              A   281    	LD	R0,#1
000000C4 7560 0013         A   282    	CP.W	_button_state:RAM,R0
000000C8 EE 06             A   283    	JP	NE,_2_L_11
                           A   284    ;   80					button_twice_timer += timer_interval_int();
                           A   285    .line 80
000000CA F1 FFFF99         A   286    	CALL	_timer_interval_int
000000CE 7070 0008         A   287    	ADD	_button_twice_timer:RAM,R0
                           A   288    ;   81					button_state = BUTTON_NOT_PRESSED;
                           A   289    .line 81
000000D2 ADA4 0013         A   290    	CLR.W	_button_state:RAM
                           A   291    ;   82				}
                           A   292    ;   83			}
                           A   293    ;   84		}
                           A   294    ;   85	}
000000D6                   A   295    _2_L_11:
                           A   296    .line 85
000000D6 0001              A   297    	UNLINK	
000000D8 FFFC              A   298    	RET	
                           A   299    
                           A   300    
                           A   301    ;**************************** _button_events ***************************
                           A   302    ;Name                         Addr/Register   Size   Type
                           A   303    ;_handle_button_events               STATIC  -----   function
                           A   304    ;_button_state                       STATIC      2   variable
                           A   305    ;_previous                           STATIC      1   variable
                           A   306    ;_current                            STATIC      1   variable
                           A   307    ;_debounce_cutoff                    STATIC      4   variable
                           A   308    ;_last_button                        STATIC      1   variable
                           A   309    ;_button_twice_cutoff                STATIC      4   variable
                           A   310    ;_button_twice_timer                 STATIC      4   variable
                           A   311    ;_timer_interval_int                 IMPORT  -----   function
                           A   312    ;_button_timer                       STATIC      4   variable
ZiLOG ZNEO Macro Assembler Version 1.10 (07022203)                                               27-Feb-11     17:33:57     page:   7


PC     Object              I  Line    Source buttons.src
                           A   313    
                           A   314    
                           A   315    ; Aggregate Stack Size: 0 (words)
                           A   316    
                           A   317    
                           A   318    .endfunc "button_events",85,"_button_events"
                           A   319    ;   86	
                           A   320    ;   87	/*
                           A   321    ;   88		Handles the button event.
                           A   322    ;   89	 */
                           A   323    ;   90	static void handle_button_events(void)
                           A   324    ;   91	{
000000DA                   A   325    _handle_button_events:
                           A   326    .define "_handle_button_events"
                           A   327    .value _handle_button_events
                           A   328    .class 3
                           A   329    .type 65
                           A   330    .type 0
                           A   331    .endef
                           A   332    .begfunc "handle_button_events",91,"_handle_button_events"
000000DA 0800              A   333    	LINK	#0
                           A   334    ;   92		if(current == BUTTON_ONE) {
                           A   335    .line 92
000000DC 4500 00C0         A   336    	LD	R0,#192
000000E0 7550 0011         A   337    	CP.B	_current:RAM,R0
000000E4 EE 12             A   338    	JP	NE,_3_L_26
                           A   339    ;   93			if(button_twice_timer && (last_button == BUTTON_ONE)) {
                           A   340    .line 93
000000E6 ADA9 0008         A   341    	CPZ	_button_twice_timer:RAM
000000EA E6 0A             A   342    	JP	EQ,_3_L_14
000000EC 7550 0010         A   343    	CP.B	_last_button:RAM,R0
000000F0 EE 07             A   344    	JP	NE,_3_L_14
                           A   345    ;   94				button_twice_timer = 0;
                           A   346    .line 94
000000F2 ADA8 0008         A   347    	CLR	_button_twice_timer:RAM
                           A   348    ;   95				last_button = BUTTON_NONE;
                           A   349    .line 95
000000F6 4500 00C8         A   350    	LD	R0,#200
000000FA 0350 0010         A   351    	LD.B	_last_button:RAM,R0
                           A   352    ;   96			}
                           A   353    ;   97			else {
                           A   354    .line 97
000000FE C033              A   355    	JP	_3_L_27
00000100                   A   356    _3_L_14:
                           A   357    ;   98				last_button = BUTTON_ONE;
                           A   358    .line 98
00000100 4500 00C0         A   359    	LD	R0,#192
00000104 0350 0010         A   360    	LD.B	_last_button:RAM,R0
                           A   361    ;   99			}
                           A   362    ;  100		}
                           A   363    ;  101		else if(current == BUTTON_TWO) {
                           A   364    .line 101
ZiLOG ZNEO Macro Assembler Version 1.10 (07022203)                                               27-Feb-11     17:33:57     page:   8


PC     Object              I  Line    Source buttons.src
00000108 C02E              A   365    	JP	_3_L_27
0000010A                   A   366    _3_L_26:
0000010A 4500 0088         A   367    	LD	R0,#136
0000010E 7550 0011         A   368    	CP.B	_current:RAM,R0
00000112 EE 12             A   369    	JP	NE,_3_L_24
                           A   370    ;  102			if(button_twice_timer && (last_button == BUTTON_TWO)) {
                           A   371    .line 102
00000114 ADA9 0008         A   372    	CPZ	_button_twice_timer:RAM
00000118 E6 0A             A   373    	JP	EQ,_3_L_17
0000011A 7550 0010         A   374    	CP.B	_last_button:RAM,R0
0000011E EE 07             A   375    	JP	NE,_3_L_17
                           A   376    ;  103				button_twice_timer = 0;
                           A   377    .line 103
00000120 ADA8 0008         A   378    	CLR	_button_twice_timer:RAM
                           A   379    ;  104				last_button = BUTTON_NONE;
                           A   380    .line 104
00000124 4500 00C8         A   381    	LD	R0,#200
00000128 0350 0010         A   382    	LD.B	_last_button:RAM,R0
                           A   383    ;  105			}
                           A   384    ;  106			else {
                           A   385    .line 106
0000012C C01C              A   386    	JP	_3_L_27
0000012E                   A   387    _3_L_17:
                           A   388    ;  107				last_button = BUTTON_TWO;
                           A   389    .line 107
0000012E 4500 0088         A   390    	LD	R0,#136
00000132 0350 0010         A   391    	LD.B	_last_button:RAM,R0
                           A   392    ;  108			}
                           A   393    ;  109		}
                           A   394    ;  110		else if(current == BUTTON_THREE) {
                           A   395    .line 110
00000136 C017              A   396    	JP	_3_L_27
00000138                   A   397    _3_L_24:
00000138 3048              A   398    	LD	R0,#72
0000013A 7550 0011         A   399    	CP.B	_current:RAM,R0
0000013E EE 11             A   400    	JP	NE,_3_L_22
                           A   401    ;  111			if(button_twice_timer && (last_button == BUTTON_THREE)) {
                           A   402    .line 111
00000140 ADA9 0008         A   403    	CPZ	_button_twice_timer:RAM
00000144 E6 0A             A   404    	JP	EQ,_3_L_20
00000146 7550 0010         A   405    	CP.B	_last_button:RAM,R0
0000014A EE 07             A   406    	JP	NE,_3_L_20
                           A   407    ;  112				button_twice_timer = 0;
                           A   408    .line 112
0000014C ADA8 0008         A   409    	CLR	_button_twice_timer:RAM
                           A   410    ;  113				last_button = BUTTON_NONE;
                           A   411    .line 113
00000150 4500 00C8         A   412    	LD	R0,#200
00000154 0350 0010         A   413    	LD.B	_last_button:RAM,R0
                           A   414    ;  114			}
                           A   415    ;  115			else {
                           A   416    .line 115
ZiLOG ZNEO Macro Assembler Version 1.10 (07022203)                                               27-Feb-11     17:33:57     page:   9


PC     Object              I  Line    Source buttons.src
00000158 C006              A   417    	JP	_3_L_27
0000015A                   A   418    _3_L_20:
                           A   419    ;  116				last_button = BUTTON_THREE;
                           A   420    .line 116
0000015A 3048              A   421    	LD	R0,#72
0000015C 0350 0010         A   422    	LD.B	_last_button:RAM,R0
                           A   423    ;  117			}
                           A   424    ;  118		}
                           A   425    ;  119		//don't do anything if multiple buttons are pressed
                           A   426    ;  120		else {
                           A   427    .line 120
00000160 C002              A   428    	JP	_3_L_27
00000162                   A   429    _3_L_22:
                           A   430    ;  121			button_state = BUTTON_NOT_PRESSED;
                           A   431    .line 121
00000162 ADA4 0013         A   432    	CLR.W	_button_state:RAM
                           A   433    ;  122		}
                           A   434    ;  123	}
00000166                   A   435    _3_L_27:
                           A   436    .line 123
00000166 0001              A   437    	UNLINK	
00000168 FFFC              A   438    	RET	
                           A   439    
                           A   440    
                           A   441    ;**************************** _handle_button_events ***************************
                           A   442    ;Name                         Addr/Register   Size   Type
                           A   443    ;_button_state                       STATIC      2   variable
                           A   444    ;_last_button                        STATIC      1   variable
                           A   445    ;_button_twice_timer                 STATIC      4   variable
                           A   446    ;_current                            STATIC      1   variable
                           A   447    
                           A   448    
                           A   449    ; Aggregate Stack Size: 0 (words)
                           A   450    
                           A   451    
                           A   452    .endfunc "handle_button_events",123,"_handle_button_events"
                           A   453    	XREF _timer_interval_int:EROM
                           A   454    	XDEF _button_events
                           A   455    	XDEF _init_buttons
                           A   456    	END


Errors: 0
Warnings: 0
Lines Assembled: 457
